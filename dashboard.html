<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | EternalWall</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .sidebar-link.active { background-color: #ffe4e6; color: #be123c; border-right: 4px solid #be123c; }
        .heart-clip { clip-path: path("M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"); }
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden font-sans">

    <!-- 1. LOGIN / REGISTER SCREEN -->
    <div id="authScreen" class="fixed inset-0 bg-gradient-to-br from-rose-500 to-purple-600 z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center">
            <h1 class="text-4xl font-bold text-rose-600 mb-2">EternalWall</h1>
            <p class="text-gray-500 mb-6">Login to access your shared world.</p>
            
            <div class="space-y-4 text-left">
                <div>
                    <label class="text-xs font-bold text-gray-600">EMAIL</label>
                    <input type="email" id="email" class="w-full border-b-2 border-gray-200 p-2 focus:border-rose-500 outline-none transition" placeholder="you@example.com">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-600">PASSWORD</label>
                    <input type="password" id="password" class="w-full border-b-2 border-gray-200 p-2 focus:border-rose-500 outline-none transition" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                <div class="pt-4 flex gap-3">
                    <button onclick="handleAuth('login')" class="flex-1 bg-gray-800 text-white py-3 rounded-lg hover:bg-black font-bold">LOGIN</button>
                    <button onclick="handleAuth('register')" class="flex-1 bg-white border-2 border-rose-500 text-rose-600 py-3 rounded-lg hover:bg-rose-50 font-bold">CREATE ACCOUNT</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. PARTNER CONNECTION "LOCK" SCREEN -->
    <div id="lockScreen" class="hidden fixed inset-0 bg-gray-100 z-[90] flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl p-8 max-w-lg w-full text-center border-t-8 border-rose-500">
            <i class="fas fa-heart-broken text-6xl text-gray-300 mb-4"></i>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Connect Your Heart</h2>
            <p class="text-gray-600 mb-6">Your dashboard is locked. You must connect with your partner to enter.</p>
            
            <div class="bg-rose-50 p-4 rounded-lg mb-6 border border-rose-200">
                <p class="text-xs text-rose-800 font-bold uppercase mb-1">Your Connection Code</p>
                <div class="text-2xl font-mono font-bold tracking-widest text-gray-800 select-all cursor-pointer" id="myUid">LOADING...</div>
                <p class="text-[10px] text-gray-500 mt-1">Share this code with your partner</p>
            </div>

            <div class="relative flex py-2 items-center">
                <div class="flex-grow border-t border-gray-300"></div>
                <span class="flex-shrink mx-4 text-gray-400 text-xs">OR ENTER PARTNER'S CODE</span>
                <div class="flex-grow border-t border-gray-300"></div>
            </div>

            <div class="mt-4 flex gap-2">
                <input type="text" id="partnerUidInput" placeholder="Paste Partner's Code Here" class="flex-1 border-2 border-gray-200 rounded-lg px-4 focus:border-rose-500 outline-none">
                <button onclick="connectPartner()" class="bg-rose-600 text-white px-6 rounded-lg font-bold hover:bg-rose-700">CONNECT</button>
            </div>
            <button onclick="logout()" class="mt-6 text-xs text-gray-400 underline">Logout</button>
        </div>
    </div>

    <!-- 3. MAIN DASHBOARD (UNLOCKED) -->
    <div id="mainDashboard" class="hidden flex h-full w-full">
        
        <!-- Sidebar -->
        <aside class="w-64 bg-white border-r flex flex-col z-20 shadow-lg">
            <div class="p-6 text-center border-b bg-rose-50">
                <h1 class="text-xl font-bold text-rose-600">EternalWall</h1>
                <p class="text-xs text-gray-500 mt-1" id="coupleCodeDisplay">Loading...</p>
            </div>
            <nav class="flex-1 overflow-y-auto no-scrollbar py-2">
                <!-- Navigation Items -->
                <button onclick="showTab('wall')" class="sidebar-link active w-full text-left px-6 py-3 text-sm font-medium text-gray-600 hover:bg-rose-50 transition"><i class="fas fa-stream w-6 text-center"></i> Lovers Wall</button>
                <button onclick="showTab('tile')" class="sidebar-link w-full text-left px-6 py-3 text-sm font-medium text-gray-600 hover:bg-rose-50 transition"><i class="fas fa-heart w-6 text-center"></i> Our Tile</button>
                <button onclick="showTab('chats')" class="sidebar-link w-full text-left px-6 py-3 text-sm font-medium text-gray-600 hover:bg-rose-50 transition"><i class="fas fa-comments w-6 text-center"></i> Private Chat</button>
                <button onclick="showTab('alerts')" class="sidebar-link w-full text-left px-6 py-3 text-sm font-medium text-gray-600 hover:bg-rose-50 transition"><i class="fas fa-bell w-6 text-center"></i> Alerts</button>
                <button onclick="showTab('goals')" class="sidebar-link w-full text-left px-6 py-3 text-sm font-medium text-gray-600 hover:bg-rose-50 transition"><i class="fas fa-bullseye w-6 text-center"></i> Goals & Dreams</button>
                <button onclick="showTab('money')" class="sidebar-link w-full text-left px-6 py-3 text-sm font-medium text-gray-600 hover:bg-rose-50 transition"><i class="fas fa-wallet w-6 text-center"></i> Money Mgmt</button>
                <button onclick="showTab('games')" class="sidebar-link w-full text-left px-6 py-3 text-sm font-medium text-gray-600 hover:bg-rose-50 transition"><i class="fas fa-gamepad w-6 text-center"></i> Games</button>
                <button onclick="showTab('business')" class="sidebar-link w-full text-left px-6 py-3 text-sm font-medium text-gray-600 hover:bg-rose-50 transition"><i class="fas fa-store w-6 text-center"></i> Online Business</button>
                <button onclick="showTab('ads')" class="sidebar-link w-full text-left px-6 py-3 text-sm font-medium text-gray-600 hover:bg-rose-50 transition"><i class="fas fa-ad w-6 text-center"></i> Our Ads</button>
                <button onclick="showTab('market')" class="sidebar-link w-full text-left px-6 py-3 text-sm font-medium text-gray-600 hover:bg-rose-50 transition"><i class="fas fa-shopping-bag w-6 text-center"></i> Marketplace</button>
                <button onclick="showTab('bizmsg')" class="sidebar-link w-full text-left px-6 py-3 text-sm font-medium text-gray-600 hover:bg-rose-50 transition"><i class="fas fa-envelope w-6 text-center"></i> Biz Messages</button>
                <div class="mt-auto border-t p-4">
                    <button onclick="logout()" class="w-full text-left text-red-500 text-sm hover:underline"><i class="fas fa-sign-out-alt"></i> Logout</button>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto bg-gray-50 relative p-6 md:p-10" id="contentArea">
            
            <!-- 10. LOVERS WALL -->
            <div id="wall" class="tab-content">
                <h2 class="text-3xl font-bold mb-6 text-gray-800">Lovers Wall</h2>
                <!-- Post Creator -->
                <div class="bg-white p-6 rounded-xl shadow-sm mb-8">
                    <textarea id="wallText" class="w-full border-gray-100 bg-gray-50 p-4 rounded-lg focus:outline-rose-500" placeholder="Write a memory... (Requires partner approval)"></textarea>
                    <input id="wallImg" type="text" class="w-full mt-2 p-2 text-sm border-b" placeholder="Paste Image URL (Optional)">
                    <div class="mt-4 flex justify-end">
                        <button onclick="postWall()" class="bg-rose-600 text-white px-6 py-2 rounded-lg hover:bg-rose-700 shadow transition">Request Post</button>
                    </div>
                </div>
                <!-- Feed -->
                <div id="wallFeed" class="space-y-6 max-w-2xl mx-auto"></div>
            </div>

            <!-- 1. OUR TILE -->
            <div id="tile" class="tab-content hidden">
                <h2 class="text-3xl font-bold mb-6 text-gray-800">Edit Public Tile</h2>
                
                <div id="pendingTile" class="hidden bg-yellow-100 text-yellow-800 p-4 rounded mb-6 flex justify-between items-center">
                    <span>Partner requested changes to your tile!</span>
                    <button onclick="approveTile()" class="bg-yellow-600 text-white px-4 py-1 rounded hover:bg-yellow-700">Approve</button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                    <div class="bg-white p-8 rounded-xl shadow-sm">
                        <label class="block text-xs font-bold text-gray-500 mb-1">COUPLE NAMES</label>
                        <input id="tileNames" type="text" class="w-full border p-2 rounded mb-4" placeholder="e.g. Romeo & Juliet">
                        
                        <label class="block text-xs font-bold text-gray-500 mb-1">LOVE CITY (MAP LOCATION)</label>
                        <input id="tileCity" type="text" class="w-full border p-2 rounded mb-4" placeholder="e.g. Verona">
                        
                        <label class="block text-xs font-bold text-gray-500 mb-1">RELATIONSHIP BADGE</label>
                        <select id="tileBadge" class="w-full border p-2 rounded mb-4">
                            <option>Dating</option>
                            <option>Engaged</option>
                            <option>Married</option>
                            <option>Future Husband & Wife</option>
                        </select>
                        
                        <label class="block text-xs font-bold text-gray-500 mb-1">SLOGAN</label>
                        <input id="tileSlogan" type="text" class="w-full border p-2 rounded mb-6" placeholder="e.g. 'Forever starts now'">
                        
                        <button onclick="requestTile()" class="w-full bg-gray-800 text-white py-3 rounded hover:bg-black transition">Save & Request Update</button>
                    </div>

                    <div class="flex justify-center items-start pt-10">
                        <div class="bg-white p-6 rounded-2xl shadow-2xl text-center w-72 transform rotate-1">
                            <div class="w-24 h-24 bg-rose-100 mx-auto mb-4 heart-clip flex items-center justify-center text-rose-300">
                                <i class="fas fa-camera text-2xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-rose-600 mb-1">Preview</h3>
                            <p class="text-xs text-gray-400 mb-2">City Name</p>
                            <span class="inline-block bg-amber-100 text-amber-800 text-[10px] font-bold px-2 py-1 rounded uppercase">Badge Status</span>
                            <p class="text-sm italic text-gray-600 mt-4">"Slogan appears here"</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 4. CHATS -->
            <div id="chats" class="tab-content hidden h-[85vh] flex flex-col">
                <h2 class="text-3xl font-bold mb-4">Chat</h2>
                <div id="chatBox" class="flex-1 bg-white rounded-xl shadow-inner p-4 overflow-y-auto mb-4 space-y-3"></div>
                <div class="flex gap-2">
                    <input id="chatInput" type="text" class="flex-1 border p-3 rounded-lg focus:outline-rose-500" placeholder="Type a message...">
                    <button onclick="sendChat()" class="bg-rose-600 text-white px-6 rounded-lg hover:bg-rose-700"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>

            <!-- 5. ALERTS -->
            <div id="alerts" class="tab-content hidden">
                <h2 class="text-3xl font-bold mb-6">Scheduled Alerts</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h3 class="font-bold text-lg mb-4">Create Surprise</h3>
                        <input id="alertTitle" type="text" placeholder="Title (e.g. Happy Anniversary)" class="w-full border p-2 rounded mb-3">
                        <textarea id="alertMsg" placeholder="Message..." class="w-full border p-2 rounded mb-3 h-24"></textarea>
                        <div class="flex gap-2 mb-4">
                            <input id="alertDate" type="date" class="border p-2 rounded flex-1">
                            <input id="alertTime" type="time" class="border p-2 rounded flex-1">
                        </div>
                        <button onclick="createAlert()" class="bg-purple-600 text-white w-full py-2 rounded hover:bg-purple-700">Schedule</button>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h3 class="font-bold text-lg mb-4">Upcoming</h3>
                        <div id="alertList" class="space-y-2 text-sm text-gray-600"></div>
                    </div>
                </div>
            </div>

            <!-- 7. GAMES -->
            <div id="games" class="tab-content hidden">
                <h2 class="text-3xl font-bold mb-6">Tic-Tac-Love</h2>
                <div class="max-w-md mx-auto bg-white p-8 rounded-xl shadow text-center">
                    <div id="gameBoard" class="grid grid-cols-3 gap-2 mb-4 w-48 mx-auto"></div>
                    <button onclick="resetGame()" class="text-xs text-gray-400 underline">Reset Board</button>
                </div>
            </div>

            <!-- 9. ADS -->
            <div id="ads" class="tab-content hidden">
                <h2 class="text-3xl font-bold mb-6">Manage Profile Ad</h2>
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <p class="text-sm text-gray-500 mb-4">This ad will appear when people scroll down on your public profile popup.</p>
                    <textarea id="adHtml" class="w-full border p-2 rounded mb-4 font-mono text-sm h-32" placeholder="Write HTML content for your ad (Text, Image Links, Contact)"></textarea>
                    <button onclick="saveAd()" class="bg-green-600 text-white px-6 py-2 rounded">Publish Ad</button>
                </div>
            </div>

            <!-- 8. BUSINESS -->
            <div id="business" class="tab-content hidden">
                <h2 class="text-3xl font-bold mb-6">Our Store</h2>
                <div class="bg-white p-6 rounded-xl shadow-sm mb-6">
                    <div class="flex gap-2 mb-4">
                        <input id="prodName" type="text" placeholder="Product Name" class="flex-1 border p-2 rounded">
                        <input id="prodPrice" type="number" placeholder="Price" class="w-24 border p-2 rounded">
                        <button onclick="addProd()" class="bg-blue-600 text-white px-4 rounded">Add</button>
                    </div>
                    <ul id="storeList" class="divide-y"></ul>
                </div>
            </div>

            <!-- Placeholders for others to keep code concise but working -->
            <div id="market" class="tab-content hidden"><h2 class="text-3xl font-bold">Marketplace</h2><div id="marketFeed" class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4"></div></div>
            <div id="goals" class="tab-content hidden"><h2 class="text-3xl font-bold">Goals</h2><p class="mt-4 text-gray-500">Feature coming in next update.</p></div>
            <div id="money" class="tab-content hidden"><h2 class="text-3xl font-bold">Money</h2><p class="mt-4 text-gray-500">Feature coming in next update.</p></div>
            <div id="bizmsg" class="tab-content hidden"><h2 class="text-3xl font-bold">Messages</h2><p class="mt-4 text-gray-500">Feature coming in next update.</p></div>

        </main>
    </div>

    <!-- FIREBASE LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getDatabase, ref, set, get, update, push, onValue, child } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBUjzMFao9BS3uXBOW3qYrLVqHaGn8qIk4",
            authDomain: "onlineshop-30cd1.firebaseapp.com",
            databaseURL: "https://onlineshop-30cd1-default-rtdb.firebaseio.com",
            projectId: "onlineshop-30cd1",
            storageBucket: "onlineshop-30cd1.firebasestorage.app",
            messagingSenderId: "818252574868",
            appId: "1:818252574868:web:8dd36825db589a886cc481",
            measurementId: "G-6YLGGH2NDD"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let user = null;
        let coupleId = null;

        // --- AUTH LOGIC ---
        window.handleAuth = (type) => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            if(!e || !p) return alert("Please fill fields");

            if(type === 'register') {
                createUserWithEmailAndPassword(auth, e, p)
                .then(cred => {
                    // Create minimal user record
                    set(ref(db, 'users/' + cred.user.uid), {
                        email: e,
                        partner: null, // Lock state
                        created: Date.now()
                    });
                }).catch(err => alert(err.message));
            } else {
                signInWithEmailAndPassword(auth, e, p).catch(err => alert(err.message));
            }
        };

        window.logout = () => signOut(auth);

        // --- STATE MANAGEMENT ---
        onAuthStateChanged(auth, (u) => {
            if (u) {
                user = u;
                document.getElementById('authScreen').classList.add('hidden');
                initUserListener();
            } else {
                user = null;
                coupleId = null;
                document.getElementById('authScreen').classList.remove('hidden');
                document.getElementById('lockScreen').classList.add('hidden');
                document.getElementById('mainDashboard').classList.add('hidden');
            }
        });

        function initUserListener() {
            // Listen to User's "partner" field
            onValue(ref(db, 'users/' + user.uid), (snap) => {
                const data = snap.val();
                if(!data) return;

                if (data.partner) {
                    // UNLOCKED
                    coupleId = data.coupleId;
                    document.getElementById('lockScreen').classList.add('hidden');
                    document.getElementById('mainDashboard').classList.remove('hidden');
                    
                    // Init Dashboard Features
                    loadDashboardData();
                } else {
                    // LOCKED
                    document.getElementById('mainDashboard').classList.add('hidden');
                    document.getElementById('lockScreen').classList.remove('hidden');
                    document.getElementById('myUid').innerText = user.uid;
                }
            });
        }

        // --- PARTNER CONNECTION LOGIC ---
        window.connectPartner = () => {
            const partnerUid = document.getElementById('partnerUidInput').value.trim();
            if(!partnerUid || partnerUid === user.uid) return alert("Invalid Partner ID");

            // Check if partner exists and is free
            get(ref(db, 'users/' + partnerUid)).then(snap => {
                if(!snap.exists()) return alert("Partner ID not found");
                if(snap.val().partner) return alert("This user is already connected!");

                // Generate ID
                const newCoupleId = [user.uid, partnerUid].sort().join('_');
                const uniqueCode = "EW-" + Math.floor(10000 + Math.random() * 90000);

                const updates = {};
                // Link User A
                updates['users/' + user.uid + '/partner'] = partnerUid;
                updates['users/' + user.uid + '/coupleId'] = newCoupleId;
                // Link User B
                updates['users/' + partnerUid + '/partner'] = user.uid;
                updates['users/' + partnerUid + '/coupleId'] = newCoupleId;
                // Init Public Profile
                updates['public_profiles/' + newCoupleId] = { code: uniqueCode, since: new Date().getFullYear() };
                
                update(ref(db), updates).then(() => {
                    alert("Connected Successfully! Dashboard Unlocking...");
                });
            });
        };

        // --- DASHBOARD FEATURES ---

        function loadDashboardData() {
            // Get Couple Code
            get(ref(db, `public_profiles/${coupleId}/code`)).then(s => {
                if(s.exists()) document.getElementById('coupleCodeDisplay').innerText = "Code: " + s.val();
            });

            // Listen for Chats
            onValue(ref(db, `couples/${coupleId}/chats`), snap => {
                const box = document.getElementById('chatBox');
                box.innerHTML = '';
                snap.forEach(c => {
                    const msg = c.val();
                    const isMe = msg.uid === user.uid;
                    box.innerHTML += `
                        <div class="flex ${isMe ? 'justify-end' : 'justify-start'}">
                            <div class="${isMe ? 'bg-rose-500 text-white' : 'bg-gray-200 text-gray-800'} rounded-lg px-4 py-2 max-w-xs text-sm">
                                ${msg.text}
                            </div>
                        </div>
                    `;
                });
                box.scrollTop = box.scrollHeight;
            });

            // Listen for Tile Requests
            onValue(ref(db, `couples/${coupleId}/pending_tile`), snap => {
                const d = snap.val();
                const div = document.getElementById('pendingTile');
                if(d && d.requester !== user.uid) div.classList.remove('hidden');
                else div.classList.add('hidden');
            });

            // Listen for Wall Feed (Public)
            onValue(ref(db, 'public_wall'), snap => {
                const feed = document.getElementById('wallFeed');
                feed.innerHTML = '';
                snap.forEach(c => {
                    const p = c.val();
                    feed.innerHTML += `
                        <div class="bg-white p-4 rounded shadow-sm border border-gray-100">
                            <div class="text-xs text-rose-500 font-bold mb-2">Couple #${p.coupleCode || 'Unknown'}</div>
                            ${p.image ? `<img src="${p.image}" class="w-full h-64 object-cover rounded mb-3">` : ''}
                            <p class="text-gray-700">${p.text}</p>
                        </div>
                    `;
                });
            });

            // Load Game State
            loadGame();

            // Load Market
            loadMarket();
        }

        // 1. Tile Functions
        window.requestTile = () => {
            const data = {
                names: document.getElementById('tileNames').value,
                city: document.getElementById('tileCity').value,
                badge: document.getElementById('tileBadge').value,
                slogan: document.getElementById('tileSlogan').value,
                requester: user.uid
            };
            set(ref(db, `couples/${coupleId}/pending_tile`), data);
            alert("Sent to partner for approval!");
        };

        window.approveTile = () => {
            get(ref(db, `couples/${coupleId}/pending_tile`)).then(snap => {
                const d = snap.val();
                update(ref(db, `public_profiles/${coupleId}`), {
                    names: d.names, city: d.city, badge: d.badge, slogan: d.slogan,
                    lat: (Math.random() * 160) - 80, // Mock lat for map
                    lng: (Math.random() * 360) - 180  // Mock lng for map
                });
                set(ref(db, `couples/${coupleId}/pending_tile`), null);
                alert("Published to World Map!");
            });
        };

        // 2. Chat
        window.sendChat = () => {
            const txt = document.getElementById('chatInput').value;
            if(!txt) return;
            push(ref(db, `couples/${coupleId}/chats`), { text: txt, uid: user.uid, ts: Date.now() });
            document.getElementById('chatInput').value = '';
        };

        // 3. Alerts
        window.createAlert = () => {
            const title = document.getElementById('alertTitle').value;
            const msg = document.getElementById('alertMsg').value;
            const dateStr = document.getElementById('alertDate').value + "T" + document.getElementById('alertTime').value;
            const ts = new Date(dateStr).getTime();
            
            push(ref(db, `couples/${coupleId}/alerts`), { title, msg, time: ts, shown: false });
            alert("Alert Scheduled");
            
            // Render list immediately (simplified)
            const list = document.getElementById('alertList');
            list.innerHTML += `<div class="bg-gray-100 p-2 rounded">${title} (Scheduled)</div>`;
        };
        
        // Check alerts loop
        setInterval(() => {
            if(!coupleId) return;
            get(ref(db, `couples/${coupleId}/alerts`)).then(snap => {
                snap.forEach(c => {
                    const a = c.val();
                    if(!a.shown && Date.now() >= a.time) {
                        alert(`ðŸ”” ALERT: ${a.title}\n${a.msg}`);
                        update(ref(db, `couples/${coupleId}/alerts/${c.key}`), { shown: true });
                    }
                });
            });
        }, 30000);

        // 4. Wall Post
        window.postWall = () => {
            const txt = document.getElementById('wallText').value;
            const img = document.getElementById('wallImg').value;
            // Get code first
            get(ref(db, `public_profiles/${coupleId}/code`)).then(s => {
                const code = s.val() || '???';
                push(ref(db, 'public_wall'), {
                    text: txt, image: img, coupleCode: code, date: Date.now()
                });
                alert("Posted!");
                document.getElementById('wallText').value = '';
            });
        };

        // 5. Game
        window.loadGame = () => {
            const board = document.getElementById('gameBoard');
            board.innerHTML = '';
            for(let i=0; i<9; i++) {
                board.innerHTML += `<div onclick="move(${i})" class="w-16 h-16 bg-rose-100 flex items-center justify-center text-2xl font-bold cursor-pointer hover:bg-rose-200 border border-white" id="cell-${i}"></div>`;
            }
            onValue(ref(db, `couples/${coupleId}/game`), snap => {
                const g = snap.val();
                if(g) Object.keys(g).forEach(k => document.getElementById(`cell-${k}`).innerText = g[k]);
                else for(let i=0; i<9; i++) document.getElementById(`cell-${i}`).innerText = '';
            });
        };
        window.move = (i) => {
            update(ref(db, `couples/${coupleId}/game`), { [i]: 'X' }); // Simple X logic
        };
        window.resetGame = () => set(ref(db, `couples/${coupleId}/game`), null);

        // 6. Ads
        window.saveAd = () => {
            const html = document.getElementById('adHtml').value;
            update(ref(db, `public_profiles/${coupleId}`), { adContent: html });
            alert("Ad Updated on Public Profile");
        };

        // 7. Business
        window.addProd = () => {
            const n = document.getElementById('prodName').value;
            const p = document.getElementById('prodPrice').value;
            push(ref(db, `couples/${coupleId}/products`), { name: n, price: p });
            push(ref(db, 'market_feed'), { name: n, price: p, seller: coupleId }); // Global market
            
            // Update UI list
            document.getElementById('storeList').innerHTML += `<li class="py-2 flex justify-between"><span>${n}</span> <span class="font-bold">$${p}</span></li>`;
        };

        // 8. Market
        function loadMarket() {
            onValue(ref(db, 'market_feed'), snap => {
                const feed = document.getElementById('marketFeed');
                feed.innerHTML = '';
                snap.forEach(c => {
                    feed.innerHTML += `
                        <div class="bg-white p-4 shadow rounded">
                            <h4 class="font-bold">${c.val().name}</h4>
                            <p class="text-rose-600 font-bold">$${c.val().price}</p>
                            <button class="text-xs bg-gray-800 text-white px-2 py-1 rounded mt-2">View Item</button>
                        </div>
                    `;
                });
            });
        }

        // Tab Switching
        window.showTab = (id) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

    </script>
</body>
</html>
