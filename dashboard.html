<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | EternalWall</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .sidebar-link.active { background-color: #ffe4e6; color: #be123c; border-right: 4px solid #be123c; }
        .clip-heart { clip-path: path("M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"); }
    </style>
</head>
<body class="bg-gray-100 h-screen flex overflow-hidden">

    <!-- Auth / Connect Overlay -->
    <div id="authOverlay" class="fixed inset-0 bg-white z-[100] flex items-center justify-center p-4">
        <div class="max-w-md w-full text-center">
            <h1 class="text-4xl font-bold text-rose-600 mb-6">EternalWall</h1>
            
            <!-- Login Form -->
            <div id="loginForm" class="space-y-4">
                <input type="email" id="email" placeholder="Email" class="w-full border p-3 rounded-lg">
                <input type="password" id="password" placeholder="Password" class="w-full border p-3 rounded-lg">
                <div class="flex gap-2">
                    <button onclick="authAction('login')" class="flex-1 bg-gray-800 text-white p-3 rounded-lg hover:bg-black">Login</button>
                    <button onclick="authAction('register')" class="flex-1 bg-rose-600 text-white p-3 rounded-lg hover:bg-rose-700">Register</button>
                </div>
            </div>

            <!-- Partner Connect Logic (Hidden initially) -->
            <div id="connectForm" class="hidden mt-8 text-left bg-rose-50 p-6 rounded-xl border border-rose-200">
                <h3 class="font-bold text-lg mb-2 text-rose-700">Connect Partner</h3>
                <p class="text-sm text-gray-600 mb-4">You need two hearts to enter. Share your ID or enter your partner's.</p>
                <div class="bg-white p-2 rounded border mb-4 text-center font-mono select-all cursor-pointer" id="myUidDisplay"></div>
                <div class="flex gap-2">
                    <input type="text" id="partnerUidInput" placeholder="Enter Partner's ID" class="flex-1 border p-2 rounded">
                    <button onclick="connectPartner()" class="bg-rose-600 text-white px-4 rounded">Connect</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <aside class="w-64 bg-white shadow-xl flex flex-col h-full z-10 hidden" id="mainSidebar">
        <div class="p-6 text-center border-b border-gray-100">
            <h2 class="font-bold text-xl text-rose-600">EternalWall</h2>
            <p class="text-xs text-gray-400 mt-1" id="coupleCodeDisplay">Loading...</p>
        </div>
        <nav class="flex-1 overflow-y-auto no-scrollbar py-2 text-sm font-medium">
            <button onclick="tab('wall')" class="sidebar-link w-full text-left px-6 py-3 text-gray-600 hover:bg-rose-50"><i class="fas fa-stream w-5"></i> Lovers Wall</button>
            <button onclick="tab('tile')" class="sidebar-link w-full text-left px-6 py-3 text-gray-600 hover:bg-rose-50"><i class="fas fa-puzzle-piece w-5"></i> Our Tile</button>
            <button onclick="tab('profile')" class="sidebar-link w-full text-left px-6 py-3 text-gray-600 hover:bg-rose-50"><i class="fas fa-user-circle w-5"></i> Our Profile</button>
            <button onclick="tab('comments')" class="sidebar-link w-full text-left px-6 py-3 text-gray-600 hover:bg-rose-50"><i class="fas fa-comments w-5"></i> Public Comments</button>
            <button onclick="tab('chats')" class="sidebar-link w-full text-left px-6 py-3 text-gray-600 hover:bg-rose-50"><i class="fas fa-comment-dots w-5"></i> Our Chats</button>
            <button onclick="tab('alerts')" class="sidebar-link w-full text-left px-6 py-3 text-gray-600 hover:bg-rose-50"><i class="fas fa-bell w-5"></i> Present/Future Alerts</button>
            <button onclick="tab('goals')" class="sidebar-link w-full text-left px-6 py-3 text-gray-600 hover:bg-rose-50"><i class="fas fa-bullseye w-5"></i> Goals & Dreams</button>
            <button onclick="tab('money')" class="sidebar-link w-full text-left px-6 py-3 text-gray-600 hover:bg-rose-50"><i class="fas fa-wallet w-5"></i> Money Mgmt</button>
            <button onclick="tab('games')" class="sidebar-link w-full text-left px-6 py-3 text-gray-600 hover:bg-rose-50"><i class="fas fa-gamepad w-5"></i> Our Games</button>
            <button onclick="tab('business')" class="sidebar-link w-full text-left px-6 py-3 text-gray-600 hover:bg-rose-50"><i class="fas fa-store w-5"></i> Online Business</button>
            <button onclick="tab('ads')" class="sidebar-link w-full text-left px-6 py-3 text-gray-600 hover:bg-rose-50"><i class="fas fa-ad w-5"></i> Our Ads</button>
            <button onclick="tab('market')" class="sidebar-link w-full text-left px-6 py-3 text-gray-600 hover:bg-rose-50"><i class="fas fa-shopping-bag w-5"></i> Marketplace</button>
            <button onclick="tab('bizmsg')" class="sidebar-link w-full text-left px-6 py-3 text-gray-600 hover:bg-rose-50"><i class="fas fa-bullhorn w-5"></i> Biz Messages</button>
            <button onclick="logout()" class="w-full text-left px-6 py-3 text-red-500 hover:bg-red-50 mt-4"><i class="fas fa-sign-out-alt w-5"></i> Logout</button>
        </nav>
    </aside>

    <!-- Main Content Area -->
    <main class="flex-1 overflow-y-auto p-8 hidden relative" id="mainContent">
        
        <!-- Tab: Lovers Wall -->
        <div id="wall" class="tab-content">
            <h2 class="text-2xl font-bold mb-4">Lovers Wall <span class="text-sm font-normal text-gray-400 ml-2">Shared Publicly</span></h2>
            <div class="bg-white p-4 rounded-lg shadow mb-6 border-l-4 border-rose-500">
                <textarea id="wallPostText" class="w-full border p-2 rounded mb-2 focus:outline-none" placeholder="Share a loving moment..."></textarea>
                <input type="text" id="wallPostImg" class="w-full border p-2 rounded mb-2 text-sm" placeholder="Image URL (optional)">
                <div class="flex justify-between items-center">
                    <button onclick="postToWall()" class="bg-rose-600 text-white px-6 py-2 rounded hover:bg-rose-700">Request to Post</button>
                    <span class="text-xs text-gray-400 italic">Partner must agree before publishing</span>
                </div>
            </div>
            <div id="wallFeed" class="space-y-6 max-w-3xl mx-auto"></div>
        </div>

        <!-- Tab: Our Tile -->
        <div id="tile" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4">Edit Public Tile</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h3 class="font-bold mb-4">Update Details</h3>
                    <input id="tileNames" type="text" placeholder="Couple Names (e.g. John & Jane)" class="w-full border p-2 rounded mb-3">
                    <input id="tileCity" type="text" placeholder="Love City" class="w-full border p-2 rounded mb-3">
                    <select id="tileBadge" class="w-full border p-2 rounded mb-3">
                        <option>Dating</option>
                        <option>Engaged</option>
                        <option>Future Husband & Wife</option>
                        <option>Married</option>
                        <option>Soulmates</option>
                    </select>
                    <input id="tileSlogan" type="text" placeholder="Slogan" class="w-full border p-2 rounded mb-3">
                    <button onclick="requestTileUpdate()" class="w-full bg-rose-600 text-white py-2 rounded">Save & Request Approval</button>
                </div>
                <div class="bg-rose-50 p-6 rounded-lg flex items-center justify-center">
                    <!-- Preview -->
                    <div class="bg-white p-6 rounded-xl shadow-xl w-64 text-center">
                        <div class="w-24 h-24 bg-gray-300 mx-auto mb-4 clip-heart"></div>
                        <h3 class="font-bold text-rose-600">Name Preview</h3>
                        <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">Badge</span>
                    </div>
                </div>
            </div>
            <div id="pendingTileAlert" class="mt-4 hidden bg-yellow-100 p-4 rounded text-yellow-800">
                Partner requested changes. <button onclick="approveTile()" class="underline font-bold">Click here to Approve</button>
            </div>
        </div>

        <!-- Tab: Chats -->
        <div id="chats" class="tab-content hidden h-[85vh] flex flex-col">
            <h2 class="text-2xl font-bold mb-2">Private Chat</h2>
            <div id="chatContainer" class="flex-1 bg-white border rounded-lg p-4 overflow-y-auto mb-4 space-y-3"></div>
            <div class="flex gap-2">
                <button class="p-2 text-gray-500 hover:bg-gray-200 rounded"><i class="fas fa-paperclip"></i></button>
                <input id="chatInput" type="text" class="flex-1 border p-2 rounded focus:outline-rose-500" placeholder="Type message...">
                <button onclick="sendChat()" class="bg-rose-600 text-white px-4 rounded"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>

        <!-- Tab: Alerts -->
        <div id="alerts" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4">Future Alerts</h2>
            <div class="bg-white p-6 rounded-lg shadow mb-6">
                <h3 class="font-bold mb-2">Create New Alert</h3>
                <div class="grid grid-cols-2 gap-4 mb-3">
                    <input id="alertTitle" type="text" placeholder="Title (e.g. Sorry!)" class="border p-2 rounded">
                    <input id="alertDate" type="datetime-local" class="border p-2 rounded">
                </div>
                <textarea id="alertMsg" class="w-full border p-2 rounded mb-3" placeholder="Message content..."></textarea>
                <button onclick="createAlert()" class="bg-purple-600 text-white px-4 py-2 rounded">Schedule Alert</button>
            </div>
            <div id="activeAlerts" class="space-y-4"></div>
        </div>

        <!-- Tab: Online Business -->
        <div id="business" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4">Our Online Store</h2>
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="font-bold mb-4">Add Product</h3>
                <input id="prodName" type="text" placeholder="Product Name" class="w-full border p-2 rounded mb-2">
                <input id="prodPrice" type="number" placeholder="Price ($)" class="w-full border p-2 rounded mb-2">
                <button onclick="addProduct()" class="bg-green-600 text-white px-4 py-2 rounded">Add to Store</button>
                
                <h3 class="font-bold mt-8 mb-2">Inventory</h3>
                <ul id="productList" class="list-disc pl-5"></ul>
            </div>
        </div>

        <!-- Tab: Games -->
        <div id="games" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4">Tic-Tac-Love</h2>
            <div class="bg-white p-10 rounded-lg shadow flex flex-col items-center">
                <div id="gameBoard" class="grid grid-cols-3 gap-2 mb-4">
                    <!-- Generated by JS -->
                </div>
                <button onclick="resetGame()" class="text-sm text-gray-500 underline">Reset Game</button>
            </div>
        </div>

        <!-- Other tabs placeholders for brevity, logic follows same pattern -->
        <div id="profile" class="tab-content hidden"><h2>Profile Settings (See Index for view)</h2></div>
        <div id="goals" class="tab-content hidden"><h2>Goals & Dreams</h2><p>Coming Soon...</p></div>
        <div id="money" class="tab-content hidden"><h2>Money Management</h2><p>Coming Soon...</p></div>
        <div id="market" class="tab-content hidden"><h2>Marketplace</h2><div id="marketFeed"></div></div>

    </main>

    <!-- JS Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getDatabase, ref, set, get, update, push, onValue, child } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBUjzMFao9BS3uXBOW3qYrLVqHaGn8qIk4",
            authDomain: "onlineshop-30cd1.firebaseapp.com",
            databaseURL: "https://onlineshop-30cd1-default-rtdb.firebaseio.com",
            projectId: "onlineshop-30cd1",
            storageBucket: "onlineshop-30cd1.firebasestorage.app",
            messagingSenderId: "818252574868",
            appId: "1:818252574868:web:8dd36825db589a886cc481",
            measurementId: "G-6YLGGH2NDD"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentUser = null;
        let coupleId = null;

        // AUTH & CONNECTION
        window.authAction = (type) => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            
            if(type === 'register') {
                createUserWithEmailAndPassword(auth, e, p).then((cred) => {
                    // Create User Record
                    set(ref(db, 'users/' + cred.user.uid), { email: e, partner: null });
                    alert('Account created! Now connect your partner.');
                }).catch(err => alert(err.message));
            } else {
                signInWithEmailAndPassword(auth, e, p).catch(err => alert(err.message));
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('loginForm').classList.add('hidden');
                checkPartnerStatus();
            } else {
                document.getElementById('authOverlay').classList.remove('hidden');
                document.getElementById('loginForm').classList.remove('hidden');
                document.getElementById('mainSidebar').classList.add('hidden');
                document.getElementById('mainContent').classList.add('hidden');
            }
        });

        function checkPartnerStatus() {
            onValue(ref(db, 'users/' + currentUser.uid), (snap) => {
                const data = snap.val();
                if (data.partner) {
                    // Active Couple
                    coupleId = data.coupleId;
                    document.getElementById('authOverlay').classList.add('hidden');
                    document.getElementById('mainSidebar').classList.remove('hidden');
                    document.getElementById('mainContent').classList.remove('hidden');
                    
                    // Generate Couple Code for UI if not exists
                    get(ref(db, 'couples/' + coupleId)).then(s => {
                        if(!s.exists()) {
                            // Init Couple Data
                            const code = "EW-" + Math.floor(1000 + Math.random() * 9000);
                            update(ref(db, 'couples/' + coupleId), { code: code, created: Date.now() });
                            update(ref(db, 'public_profiles/' + coupleId), { code: code });
                        }
                        if(s.val()) document.getElementById('coupleCodeDisplay').innerText = "Code: " + s.val().code;
                    });
                    
                    initDashboardListeners();
                } else {
                    // Needs Connection
                    document.getElementById('connectForm').classList.remove('hidden');
                    document.getElementById('myUidDisplay').innerText = currentUser.uid;
                }
            });
        }

        window.connectPartner = () => {
            const pUid = document.getElementById('partnerUidInput').value.trim();
            if(!pUid) return;
            
            // Logic: Create a couple ID (sort UIDs to make it unique per pair)
            const cId = [currentUser.uid, pUid].sort().join('_');
            
            const updates = {};
            updates['users/' + currentUser.uid + '/partner'] = pUid;
            updates['users/' + currentUser.uid + '/coupleId'] = cId;
            updates['users/' + pUid + '/partner'] = currentUser.uid;
            updates['users/' + pUid + '/coupleId'] = cId;
            
            update(ref(db), updates).then(() => {
                alert('Connected! Refreshing...');
            }).catch(e => alert("Error connecting: check ID"));
        };

        window.logout = () => signOut(auth);

        // DASHBOARD LOGIC
        window.tab = (id) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            // Update Active Style
            document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
            event.target.closest('button').classList.add('active');
            
            if(id === 'games') loadGame();
            if(id === 'business') loadProducts();
            if(id === 'market') loadMarket();
        }

        function initDashboardListeners() {
            // 1. CHAT LISTENER
            onValue(ref(db, `couples/${coupleId}/chats`), (snap) => {
                const div = document.getElementById('chatContainer');
                div.innerHTML = '';
                snap.forEach(c => {
                    const msg = c.val();
                    const align = msg.uid === currentUser.uid ? 'text-right' : 'text-left';
                    const bg = msg.uid === currentUser.uid ? 'bg-rose-100' : 'bg-gray-100';
                    div.innerHTML += `<div class="${align}"><span class="inline-block px-3 py-2 rounded mb-2 ${bg}">${msg.text}</span></div>`;
                });
                div.scrollTop = div.scrollHeight;
            });

            // 2. WALL LISTENER (Public Feed)
            onValue(ref(db, `public_wall`), (snap) => {
                const feed = document.getElementById('wallFeed');
                feed.innerHTML = '';
                snap.forEach(c => {
                    const post = c.val();
                    feed.innerHTML += `
                        <div class="bg-white p-4 rounded shadow">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-heart text-rose-500 mr-2"></i> 
                                <span class="font-bold">${post.names || 'Couple'}</span>
                            </div>
                            ${post.image ? `<img src="${post.image}" class="w-full h-64 object-cover rounded mb-2">` : ''}
                            <p>${post.text}</p>
                        </div>
                    `;
                });
            });

            // 3. TILE AGREEMENT LISTENER
            onValue(ref(db, `couples/${coupleId}/pending_tile`), (snap) => {
                if(snap.exists() && snap.val().requester !== currentUser.uid) {
                    document.getElementById('pendingTileAlert').classList.remove('hidden');
                } else {
                    document.getElementById('pendingTileAlert').classList.add('hidden');
                }
            });

            // 4. ALERTS CHECKER
            setInterval(() => {
                checkAlerts();
            }, 60000); // Check every min
        }

        // FUNCTIONS

        // Chat
        window.sendChat = () => {
            const txt = document.getElementById('chatInput').value;
            if(!txt) return;
            push(ref(db, `couples/${coupleId}/chats`), {
                text: txt,
                uid: currentUser.uid,
                ts: Date.now()
            });
            document.getElementById('chatInput').value = '';
        };

        // Tile Logic (Agreement)
        window.requestTileUpdate = () => {
            const data = {
                names: document.getElementById('tileNames').value,
                city: document.getElementById('tileCity').value,
                badge: document.getElementById('tileBadge').value,
                slogan: document.getElementById('tileSlogan').value,
                requester: currentUser.uid
            };
            set(ref(db, `couples/${coupleId}/pending_tile`), data);
            alert('Request sent to partner!');
        };

        window.approveTile = () => {
            get(ref(db, `couples/${coupleId}/pending_tile`)).then(snap => {
                const data = snap.val();
                // Update Public Node
                update(ref(db, `public_profiles/${coupleId}`), {
                    names: data.names,
                    city: data.city,
                    badge: data.badge,
                    slogan: data.slogan,
                    lat: (Math.random() * 180 - 90), // Mock Geo for map
                    lng: (Math.random() * 360 - 180)
                });
                // Clear pending
                set(ref(db, `couples/${coupleId}/pending_tile`), null);
                alert('Approved & Published to World Map!');
            });
        };

        // Wall Logic
        window.postToWall = () => {
            // Simplified: Direct post for prototype (Should follow agreement logic like tile)
            const txt = document.getElementById('wallPostText').value;
            const img = document.getElementById('wallPostImg').value;
            push(ref(db, `public_wall`), {
                text: txt,
                image: img,
                coupleId: coupleId,
                names: "Us", // Fetch real names in prod
                date: Date.now()
            });
            alert("Posted to Lovers Wall!");
        };

        // Alerts
        window.createAlert = () => {
            const title = document.getElementById('alertTitle').value;
            const date = new Date(document.getElementById('alertDate').value).getTime();
            const msg = document.getElementById('alertMsg').value;
            
            push(ref(db, `couples/${coupleId}/alerts`), {
                title, date, msg, shown: false
            });
            alert('Alert Scheduled');
        };

        function checkAlerts() {
            get(ref(db, `couples/${coupleId}/alerts`)).then(snap => {
                snap.forEach(child => {
                    const alert = child.val();
                    if(!alert.shown && Date.now() >= alert.date) {
                        alert(`SURPRISE: ${alert.title}\n${alert.msg}`);
                        update(ref(db, `couples/${coupleId}/alerts/${child.key}`), { shown: true });
                    }
                });
            });
        }

        // Business
        window.addProduct = () => {
            const n = document.getElementById('prodName').value;
            const p = document.getElementById('prodPrice').value;
            push(ref(db, `couples/${coupleId}/products`), { name: n, price: p });
            loadProducts();
            // Add to global market
            push(ref(db, `market_feed`), { name: n, price: p, seller: coupleId });
        };

        function loadProducts() {
            onValue(ref(db, `couples/${coupleId}/products`), snap => {
                const list = document.getElementById('productList');
                list.innerHTML = '';
                snap.forEach(c => {
                    list.innerHTML += `<li>${c.val().name} - $${c.val().price}</li>`;
                });
            });
        }

        function loadMarket() {
            onValue(ref(db, `market_feed`), snap => {
                const feed = document.getElementById('marketFeed');
                feed.innerHTML = '<div class="grid grid-cols-3 gap-4">';
                snap.forEach(c => {
                    feed.innerHTML += `
                        <div class="bg-white p-4 shadow rounded">
                            <h4 class="font-bold">${c.val().name}</h4>
                            <p class="text-green-600">$${c.val().price}</p>
                            <button class="bg-blue-500 text-white text-xs px-2 py-1 rounded mt-2">Buy</button>
                        </div>
                    `;
                });
                feed.innerHTML += '</div>';
            });
        }

        // Game (Tic Tac Toe)
        window.loadGame = () => {
            const board = document.getElementById('gameBoard');
            board.innerHTML = '';
            for(let i=0; i<9; i++) {
                board.innerHTML += `<div onclick="playMove(${i})" class="w-16 h-16 bg-gray-200 hover:bg-gray-300 flex items-center justify-center text-2xl font-bold cursor-pointer" id="cell-${i}"></div>`;
            }
            onValue(ref(db, `couples/${coupleId}/game`), snap => {
                const state = snap.val() || Array(9).fill(null);
                state.forEach((val, idx) => {
                    if(val) document.getElementById(`cell-${idx}`).innerText = val;
                });
            });
        };

        window.playMove = (idx) => {
             // Simplified: Just toggle X/O based on random for prototype, 
             // in real app check whose turn it is
             update(ref(db, `couples/${coupleId}/game/${idx}`), 'X');
        };

        window.resetGame = () => set(ref(db, `couples/${coupleId}/game`), null);

    </script>
</body>
</html>
