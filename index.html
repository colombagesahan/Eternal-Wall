<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EternalWall | Home</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        :root { --primary: #ff4b6e; --bg-body: #f4f7f6; --text-main: #333333; --text-muted: #888888; --border: #e0e0e0; --gold: #d4af37; }
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Nunito', sans-serif; background-color: var(--bg-body); color: var(--text-main); overflow-x: hidden; }
        .hidden { display: none !important; }
        .flex { display: flex; align-items: center; }
        .btn { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-weight: 700; transition: 0.2s; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(255, 75, 110, 0.2); }
        .btn-primary:hover { transform: translateY(-2px); }
        .btn-ghost { background: transparent; border: 1px solid var(--text-muted); color: var(--text-muted); }
        .input-std { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 15px; background: #fafafa; }

        .nav-header { background: #fff; padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1002; }
        .brand-logo { font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 1.5rem; color: var(--primary); }
        .hero-section { text-align: center; padding: 50px 20px; }
        .hero-section h1 { font-family: 'Playfair Display', serif; font-size: 2.5rem; color: #222; margin-bottom: 10px; }
        .search-input { width: 100%; padding: 15px 20px; border-radius: 30px; border: 1px solid #ddd; background: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.05); max-width: 500px; margin: 0 auto; display: block;}
        .tiles-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .tile-card { background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); cursor: pointer; aspect-ratio: 1; position: relative; }
        .tile-img { width: 100%; height: 100%; object-fit: cover; }
        .tile-overlay { position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); padding: 20px 10px 10px; color: white; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; justify-content: center; align-items: center; }
        .modal-box { background: #fff; padding: 30px; border-radius: 12px; width: 90%; max-width: 400px; text-align: center; }
    </style>
</head>
<body>

    <header class="nav-header">
        <div class="brand-logo">EternalWall</div>
        <div class="flex" style="gap: 10px;">
            <button class="btn btn-ghost" onclick="openAuth('login')">Login</button>
            <button class="btn btn-primary" onclick="openAuth('signup')">Create Account</button>
        </div>
    </header>

    <section class="hero-section">
        <h1>The Sanctuary of Us</h1>
        <p>A private digital sanctuary for couples.<br>Mutual respect. Shared dreams. Memories that last.</p>
        <div class="search-wrap">
            <input type="text" id="search-bar" class="search-input" placeholder="Search for a couple..." onkeyup="filterTiles()">
        </div>
    </section>

    <section class="tiles-grid" id="public-grid"></section>

    <div id="auth-modal" class="modal-overlay hidden">
        <div class="modal-box">
            <h2 id="auth-title" style="margin-bottom: 20px; color: #333;">Login</h2>
            <div id="invite-alert" class="hidden" style="background: #fff0f3; color: var(--primary); padding: 10px; margin-bottom: 15px;">Joining Partner!</div>
            <input type="email" id="email" class="input-std" placeholder="Email Address">
            <input type="password" id="pass" class="input-std" placeholder="Password">
            <div style="text-align: left; margin-bottom: 15px;">
                <input type="checkbox" id="show-pass" onclick="togglePasswordVisibility()">
                <label for="show-pass" style="font-size: 0.9rem; color: #666;">Show Password</label>
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="handleAuth()">Submit</button>
            <div style="margin-top: 15px; color: #888; cursor: pointer;" onclick="document.getElementById('auth-modal').classList.add('hidden')">Cancel</div>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBUjzMFao9BS3uXBOW3qYrLVqHaGn8qIk4", authDomain: "onlineshop-30cd1.firebaseapp.com", databaseURL: "https://onlineshop-30cd1-default-rtdb.firebaseio.com", projectId: "onlineshop-30cd1", messagingSenderId: "818252574868", appId: "1:818252574868:web:8dd36825db589a886cc481" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let isSignup = false;
        let inviteCode = new URLSearchParams(window.location.search).get('invite');
        if(inviteCode === 'undefined' || inviteCode === 'null') inviteCode = null; // Safety check

        window.onload = () => {
            if(inviteCode) openAuth('signup');
            loadPublicTiles();
        };

        // FIX: Prevent redirect if in the middle of signup process
        auth.onAuthStateChanged(u => {
            if(u && !isSignup) {
                window.location.href = "dashboard.html";
            }
        });

        function openAuth(mode) {
            isSignup = (mode === 'signup');
            document.getElementById('auth-title').innerText = isSignup ? "Create Account" : "Login";
            document.getElementById('auth-modal').classList.remove('hidden');
            if(isSignup && inviteCode) document.getElementById('invite-alert').classList.remove('hidden');
        }

        function togglePasswordVisibility() {
            const x = document.getElementById('pass');
            x.type = x.type === "password" ? "text" : "password";
        }

        async function handleAuth() {
            const e = document.getElementById('email').value;
            const p = document.getElementById('pass').value;
            try {
                if(isSignup) {
                    const cred = await auth.createUserWithEmailAndPassword(e, p);
                    const uid = cred.user.uid;
                    
                    // Database writes happen HERE. We wait for them.
                    if(inviteCode) {
                        await db.ref(`couples/${inviteCode}`).update({ user2: uid });
                        await db.ref(`users/${uid}`).set({ coupleId: inviteCode });
                    } else {
                        const cid = "EW-" + Math.floor(1000 + Math.random() * 9000);
                        await db.ref(`couples/${cid}`).set({ user1: uid, created: Date.now() });
                        await db.ref(`users/${uid}`).set({ coupleId: cid });
                    }
                    
                    // FIX: Manual Redirect AFTER DB write success
                    window.location.href = "dashboard.html";
                    
                } else {
                    await auth.signInWithEmailAndPassword(e, p);
                    // Standard login relies on onAuthStateChanged to redirect
                }
                document.getElementById('auth-modal').classList.add('hidden');
            } catch(err) { alert(err.message); }
        }

        function loadPublicTiles() {
             db.ref('publicWall').limitToLast(20).on('value', s => {
                const g = document.getElementById('public-grid'); g.innerHTML = "";
                if(s.exists()) {
                    const list = [];
                    s.forEach(c => list.push(c.val()));
                    list.reverse().forEach(p => {
                        g.innerHTML += `
                        <div class="tile-card">
                            <img src="${p.image}" class="tile-img">
                            <div class="tile-overlay">${p.names || 'Couple'}</div>
                        </div>`;
                    });
                }
            });
        }
        
        function filterTiles() {
            const term = document.getElementById('search-bar').value.toLowerCase();
            document.querySelectorAll('.tile-card').forEach(card => {
                const txt = card.innerText.toLowerCase();
                card.style.display = txt.includes(term) ? 'block' : 'none';
            });
        }
    </script>
</body>
</html>
