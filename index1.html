<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ETERNAL WALL | The Super-App for Couples</title>
    
    <!-- Libraries -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <!-- Confetti for Celebrations -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --bg: #050505; --surface: #141414; --surface-light: #1f1f1f;
            --primary: #d4af37; /* Gold */
            --accent: #e91e63; /* Pink */
            --text: #e0e0e0; --text-dim: #888;
            --border: #333;
            --glass: rgba(20, 20, 20, 0.9);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; padding-bottom: 80px; overflow-x: hidden; }
        h1, h2, h3, .serif { font-family: 'Playfair Display', serif; }
        button { cursor: pointer; font-family: inherit; transition: 0.2s; }
        
        /* --- UTILS --- */
        .btn { padding: 10px 20px; border-radius: 50px; border: none; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; font-size: 0.9rem; }
        .btn-gold { background: var(--primary); color: #000; }
        .btn-gold:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(212, 175, 55, 0.3); }
        .btn-outline { border: 1px solid var(--border); background: transparent; color: var(--text); }
        .input-box { width: 100%; background: var(--surface-light); border: 1px solid var(--border); color: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; }
        
        /* --- NAV --- */
        .navbar { position: sticky; top: 0; z-index: 100; background: var(--glass); backdrop-filter: blur(10px); padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .brand { font-size: 1.2rem; color: var(--primary); letter-spacing: 1px; font-weight: bold; text-decoration: none; }

        /* --- VIEWS --- */
        .view { display: none; animation: fadeIn 0.5s; min-height: 90vh; }
        .active-view { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- HOME: LOVE MAP --- */
        .map-container { position: relative; height: 60vh; background: #0b0b0b; overflow: hidden; border-bottom: 1px solid var(--border); }
        .world-map { width: 100%; height: 100%; object-fit: cover; opacity: 0.3; }
        .map-dot { position: absolute; width: 8px; height: 8px; background: var(--accent); border-radius: 50%; animation: pulse 2s infinite; box-shadow: 0 0 10px var(--accent); }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(3); opacity: 0; } }
        .home-content { padding: 40px 20px; text-align: center; }
        
        /* --- DASHBOARD GRID --- */
        .dash-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        .card { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 20px; overflow: hidden; margin-bottom: 20px; }
        
        /* 1. CLOCK */
        .clock-display { text-align: center; padding: 20px; background: linear-gradient(45deg, #111, #1a1a1a); border-bottom: 1px solid var(--border); }
        .time-digits { font-size: 2rem; font-family: monospace; color: var(--primary); letter-spacing: 2px; text-shadow: 0 0 10px rgba(212, 175, 55, 0.3); }
        .time-label { color: var(--text-dim); font-size: 0.8rem; margin-top: 5px; text-transform: uppercase; }

        /* 2. DAILY PULSE */
        .pulse-card { background: linear-gradient(135deg, #2a0a12, #000); border: 1px solid var(--accent); }
        .blur-text { filter: blur(8px); user-select: none; transition: 0.5s; cursor: pointer; }
        .blur-text:hover { filter: blur(4px); }
        .revealed { filter: blur(0); }
        .q-badge { background: var(--accent); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }

        /* 3. TIME CAPSULE */
        .capsule-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--surface-light); margin-bottom: 8px; border-radius: 8px; }
        .lock-icon { font-size: 1.2rem; color: var(--text-dim); }
        .unlocked-icon { color: var(--primary); }
        
        /* 4. TOOLKIT */
        .tool-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .tool-btn { background: var(--surface-light); border: 1px solid var(--border); padding: 15px; border-radius: 12px; text-align: center; cursor: pointer; transition: 0.2s; }
        .tool-btn:hover { border-color: var(--primary); background: #222; }
        .tool-btn i { font-size: 1.5rem; margin-bottom: 5px; color: var(--text); }

        /* CHAT */
        .chat-window { height: 400px; display: flex; flex-direction: column; }
        .chat-feed { flex: 1; overflow-y: auto; padding-right: 5px; display: flex; flex-direction: column; gap: 8px; }
        .msg { padding: 8px 12px; border-radius: 12px; font-size: 0.9rem; max-width: 80%; }
        .msg-me { background: var(--primary); color: #000; align-self: flex-end; }
        .msg-partner { background: #333; align-self: flex-start; }
        .sys-msg { align-self: center; font-size: 0.8rem; color: var(--text-dim); background: rgba(255,255,255,0.05); padding: 4px 10px; border-radius: 20px; margin: 10px 0; }

        /* MOBILE */
        @media (max-width: 768px) { .dash-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <nav class="navbar">
        <a href="#" onclick="route('home')" class="brand"><i class="fas fa-infinity"></i> ETERNAL</a>
        <div id="nav-actions"></div>
    </nav>

    <!-- VIEW: HOME (LOVE MAP) -->
    <div id="view-home" class="view active-view">
        <div class="map-container" id="map-bg">
            <!-- Simulated World Map Background -->
            <img src="https://upload.wikimedia.org/wikipedia/commons/8/80/World_map_-_low_resolution.svg" class="world-map">
            <!-- Dots injected by JS -->
        </div>
        <div class="home-content">
            <h1 class="serif" style="font-size: 2.5rem; margin-bottom: 10px;">The World of Us</h1>
            <p style="color: var(--text-dim); max-width: 500px; margin: 0 auto 30px;">Join 2.4 Million couples building their digital legacy.</p>
            <div id="home-tiles" style="display:flex; gap:5px; justify-content:center; flex-wrap:wrap;"></div>
        </div>
    </div>

    <!-- VIEW: DASHBOARD (THE SUPER APP) -->
    <div id="view-dashboard" class="view">
        
        <!-- RELATIONSHIP CLOCK -->
        <div class="clock-display" id="clock-section" style="display:none;">
            <div class="time-label">WE HAVE BEEN TOGETHER FOR</div>
            <div class="time-digits" id="timer-val">00 : 00 : 00 : 00</div>
            <div class="time-label">YEARS : DAYS : HOURS : MINS</div>
            <button class="btn btn-outline" style="margin-top:15px; font-size:0.7rem;" onclick="shareClock()"><i class="fas fa-share-alt"></i> Share to Story</button>
        </div>

        <div class="dash-grid">
            <!-- LEFT COL -->
            <div class="dash-col">
                
                <!-- DAILY PULSE -->
                <div class="card pulse-card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <span class="q-badge">DAILY PULSE</span>
                        <small style="color:#aaa" id="pulse-date">Today</small>
                    </div>
                    <h3 class="serif" id="pulse-q" style="margin:0 0 15px 0;">Loading Question...</h3>
                    
                    <div id="pulse-answers">
                        <input type="text" id="my-answer" class="input-box" placeholder="Your Answer..." style="background:rgba(0,0,0,0.5);">
                        <button class="btn btn-gold" style="width:100%" onclick="submitPulse()">Answer to Reveal</button>
                    </div>
                    
                    <div id="pulse-reveal" style="display:none; margin-top:15px;">
                        <div style="margin-bottom:10px;">
                            <small style="color:var(--text-dim)">YOU</small>
                            <div id="ans-me" style="font-weight:bold;">-</div>
                        </div>
                        <div>
                            <small style="color:var(--text-dim)">PARTNER</small>
                            <div id="ans-partner" class="blur-text" onclick="this.classList.add('revealed')">-</div>
                        </div>
                    </div>
                </div>

                <!-- TIME CAPSULE -->
                <div class="card">
                    <h3 class="serif"><i class="fas fa-box"></i> Time Capsule</h3>
                    <div style="display:flex; gap:5px; margin-bottom:15px;">
                        <input type="text" id="capsule-msg" class="input-box" placeholder="Message for future..." style="margin:0;">
                        <input type="date" id="capsule-date" class="input-box" style="width:130px; margin:0;">
                    </div>
                    <button class="btn btn-outline" style="width:100%; margin-bottom:15px;" onclick="addCapsule()">Lock Away</button>
                    
                    <div id="capsule-list">
                        <!-- Items -->
                    </div>
                </div>

            </div>

            <!-- RIGHT COL -->
            <div class="dash-col">
                
                <!-- TOOLKIT -->
                <div class="card">
                    <h4 style="margin:0 0 15px 0; color:var(--text-dim);">ARGUMENT SOLVER</h4>
                    <div class="tool-grid">
                        <div class="tool-btn" onclick="runTool('coin')">
                            <i class="fas fa-coins" style="color:#ffd700;"></i>
                            <div>Flip Coin</div>
                        </div>
                        <div class="tool-btn" onclick="runTool('dice')">
                            <i class="fas fa-dice" style="color:#ff304f;"></i>
                            <div>Roll Dice</div>
                        </div>
                        <div class="tool-btn" onclick="runTool('wheel')">
                            <i class="fas fa-pizza-slice" style="color:#4caf50;"></i>
                            <div>Dinner Wheel</div>
                        </div>
                        <div class="tool-btn" onclick="runTool('sorry')">
                            <i class="fas fa-heart-broken" style="color:#2196f3;"></i>
                            <div>Send "Sorry"</div>
                        </div>
                    </div>
                </div>

                <!-- CHAT -->
                <div class="card chat-window">
                    <div class="chat-feed" id="chat-feed"></div>
                    <div style="margin-top:10px; display:flex; gap:5px;">
                        <input id="chat-in" class="input-box" style="margin:0; border-radius:20px;" placeholder="Message...">
                        <button onclick="sendChat()" style="background:var(--primary); width:40px; height:40px; border-radius:50%; border:none;"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- VIEW: AUTH -->
    <div id="view-auth" class="view" style="display:flex; justify-content:center; align-items:center;">
        <div class="card" style="width:100%; max-width:400px; text-align:center;">
            <h2 class="serif">Welcome</h2>
            <div id="blink-msg" style="background:var(--accent); color:white; padding:10px; border-radius:5px; display:none; margin-bottom:15px;">
                <i class="fas fa-link"></i> Connecting you to partner...
            </div>
            <input id="u-name" class="input-box" placeholder="Name" style="display:none;">
            <input id="u-email" class="input-box" placeholder="Email">
            <input id="u-pass" type="password" class="input-box" placeholder="Password">
            <button class="btn btn-gold" style="width:100%; margin-top:10px;" onclick="handleAuth()">Enter</button>
            <p style="font-size:0.8rem; cursor:pointer; color:var(--text-dim);" onclick="toggleAuth()" id="auth-switch">New? Create Account</p>
        </div>
    </div>

    <script>
        // --- 1. CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBUjzMFao9BS3uXBOW3qYrLVqHaGn8qIk4",
            authDomain: "onlineshop-30cd1.firebaseapp.com",
            databaseURL: "https://onlineshop-30cd1-default-rtdb.firebaseio.com",
            projectId: "onlineshop-30cd1",
            storageBucket: "onlineshop-30cd1.firebasestorage.app",
            messagingSenderId: "818252574868",
            appId: "1:818252574868:web:8dd36825db589a886cc481",
            measurementId: "G-6YLGGH2NDD"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let currentUser = null;
        let coupleId = null;
        let isSignup = false;

        // --- 2. ROUTING & MAP FX ---
        function route(page) {
            document.querySelectorAll('.view').forEach(e => e.classList.remove('active-view'));
            
            const params = new URLSearchParams(window.location.search);
            if(params.get('blink')) page = 'auth';
            if(!page) page = 'home';
            
            document.getElementById(`view-${page}`).classList.add('active-view');
            updateNav();

            if(page === 'home') startMapFX();
            if(page === 'auth' && params.get('blink')) setupBlink();
        }

        function updateNav() {
            const el = document.getElementById('nav-actions');
            if(currentUser) {
                el.innerHTML = `<button class="btn btn-outline" onclick="route('dashboard')">Dashboard</button>`;
            } else {
                el.innerHTML = `<button class="btn btn-gold" onclick="route('auth')">Login</button>`;
            }
        }

        function startMapFX() {
            const map = document.getElementById('map-bg');
            // Remove old dots
            document.querySelectorAll('.map-dot').forEach(e => e.remove());
            // Create random pulsing dots
            for(let i=0; i<15; i++) {
                setTimeout(() => {
                    const dot = document.createElement('div');
                    dot.className = 'map-dot';
                    dot.style.top = Math.random() * 80 + 10 + '%';
                    dot.style.left = Math.random() * 90 + 5 + '%';
                    map.appendChild(dot);
                }, i * 500);
            }
        }

        // --- 3. AUTH & SETUP ---
        function toggleAuth() {
            isSignup = !isSignup;
            document.getElementById('u-name').style.display = isSignup ? 'block' : 'none';
            document.getElementById('auth-switch').innerText = isSignup ? "Log In" : "Create Account";
        }
        function setupBlink() {
            isSignup = true;
            toggleAuth(); isSignup = true; // reset visual
            document.getElementById('blink-msg').style.display = 'block';
            document.getElementById('auth-switch').style.display = 'none';
        }

        async function handleAuth() {
            const email = document.getElementById('u-email').value;
            const pass = document.getElementById('u-pass').value;
            const name = document.getElementById('u-name').value;
            const blink = new URLSearchParams(window.location.search).get('blink');

            try {
                if(isSignup) {
                    const cred = await auth.createUserWithEmailAndPassword(email, pass);
                    const uid = cred.user.uid;
                    let cid = null;
                    if(blink) {
                        const inviter = (await db.ref(`users/${blink}`).once('value')).val();
                        if(inviter && !inviter.coupleId) {
                            cid = `c_${Date.now()}`;
                            // Establish Relationship Start Date as NOW
                            await db.ref(`couples/${cid}`).set({ 
                                u1: blink, u2: uid, start: Date.now(),
                                created: Date.now() 
                            });
                            await db.ref(`users/${blink}`).update({ coupleId: cid });
                        }
                    }
                    await db.ref(`users/${uid}`).set({ name, email, coupleId: cid });
                    window.history.replaceState({},'',location.pathname);
                } else {
                    await auth.signInWithEmailAndPassword(email, pass);
                }
                route('dashboard');
            } catch(e) { alert(e.message); }
        }

        // --- 4. DASHBOARD CORE ---
        auth.onAuthStateChanged(user => {
            currentUser = user;
            updateNav();
            if(user) {
                db.ref(`users/${user.uid}`).on('value', s => {
                    const d = s.val();
                    if(d.coupleId) {
                        coupleId = d.coupleId;
                        initSuperApp();
                    } else {
                        // Create a temporary couple ID for singles to view dashboard features (demo mode)
                        // In real app, show "Invite Partner" screen
                        alert("Please invite a partner to unlock full features! (Link in URL)");
                        window.history.replaceState({},'',`?blink=${user.uid}`);
                    }
                });
            }
        });

        function initSuperApp() {
            initClock();
            initPulse();
            initCapsules();
            initChat();
        }

        // --- FEATURE 1: CLOCK ---
        function initClock() {
            document.getElementById('clock-section').style.display = 'block';
            db.ref(`couples/${coupleId}/start`).on('value', s => {
                const start = s.val() || Date.now();
                setInterval(() => {
                    const diff = Date.now() - start;
                    const d = Math.floor(diff / (1000 * 60 * 60 * 24));
                    const h = Math.floor((diff / (1000 * 60 * 60)) % 24);
                    const m = Math.floor((diff / 1000 / 60) % 60);
                    const y = Math.floor(d / 365);
                    const remD = d % 365;
                    document.getElementById('timer-val').innerText = 
                        `${y} : ${remD} : ${h} : ${m}`;
                }, 1000);
            });
        }
        function shareClock() {
            alert("Generating Instagram Story image... (Simulated)");
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
        }

        // --- FEATURE 2: DAILY PULSE ---
        const QUESTIONS = [
            "What is your favorite memory of us?",
            "Where do you want to be in 5 years?",
            "What meal represents our love?",
            "Who is the better driver?"
        ];
        
        function initPulse() {
            // Pick question based on Day of Year
            const qIdx = Math.floor(Date.now() / 86400000) % QUESTIONS.length;
            document.getElementById('pulse-q').innerText = QUESTIONS[qIdx];
            
            // Listen for answers
            const dateKey = new Date().toISOString().split('T')[0];
            db.ref(`couples/${coupleId}/pulse/${dateKey}`).on('value', s => {
                const data = s.val() || {};
                const myAns = data[currentUser.uid];
                const partnerAns = Object.values(data).find(v => v !== myAns); // simplistic logic
                
                if(myAns) {
                    document.getElementById('pulse-answers').style.display = 'none';
                    document.getElementById('pulse-reveal').style.display = 'block';
                    document.getElementById('ans-me').innerText = myAns;
                    
                    if(Object.keys(data).length >= 2) {
                        // Both answered
                        document.getElementById('ans-partner').innerText = partnerAns || "Error";
                    } else {
                        document.getElementById('ans-partner').innerText = "Waiting for partner...";
                        document.getElementById('ans-partner').classList.remove('blur-text');
                    }
                }
            });
        }

        function submitPulse() {
            const ans = document.getElementById('my-answer').value;
            if(!ans) return;
            const dateKey = new Date().toISOString().split('T')[0];
            db.ref(`couples/${coupleId}/pulse/${dateKey}`).update({
                [currentUser.uid]: ans
            });
        }

        // --- FEATURE 3: TIME CAPSULE ---
        function initCapsules() {
            db.ref(`couples/${coupleId}/capsules`).on('value', s => {
                const list = document.getElementById('capsule-list');
                list.innerHTML = "";
                const data = s.val();
                if(!data) return;

                Object.values(data).forEach(c => {
                    const isLocked = Date.now() < c.unlock;
                    const div = document.createElement('div');
                    div.className = 'capsule-item';
                    
                    if(isLocked) {
                        const dateStr = new Date(c.unlock).toDateString();
                        div.innerHTML = `<i class="fas fa-lock lock-icon"></i> <div>Locked until ${dateStr}</div>`;
                    } else {
                        div.innerHTML = `<i class="fas fa-box-open unlocked-icon"></i> <div>"${c.msg}"</div>`;
                    }
                    list.appendChild(div);
                });
            });
        }

        function addCapsule() {
            const msg = document.getElementById('capsule-msg').value;
            const dateVal = document.getElementById('capsule-date').value;
            if(!msg || !dateVal) return alert("Message and Date required");
            
            const unlockTS = new Date(dateVal).getTime();
            if(unlockTS <= Date.now()) return alert("Date must be in future");

            db.ref(`couples/${coupleId}/capsules`).push({
                msg: msg, unlock: unlockTS
            });
            document.getElementById('capsule-msg').value = "";
        }

        // --- FEATURE 4: TOOLKIT ---
        function runTool(type) {
            let res = "";
            if(type === 'coin') res = Math.random() > 0.5 ? "Heads" : "Tails";
            if(type === 'dice') res = Math.floor(Math.random() * 6) + 1;
            if(type === 'wheel') {
                const foods = ["Pizza", "Sushi", "Burgers", "Tacos"];
                res = foods[Math.floor(Math.random()*foods.length)];
            }
            if(type === 'sorry') res = "Sent a Virtual Hug & Apology ❤️";

            // Send system message to chat
            db.ref(`couples/${coupleId}/chat`).push({
                text: `[TOOL] Used ${type.toUpperCase()}: Result = ${res}`,
                sys: true,
                timestamp: Date.now()
            });
        }

        // --- CHAT ---
        function initChat() {
            db.ref(`couples/${coupleId}/chat`).limitToLast(50).on('child_added', s => {
                const m = s.val();
                const d = document.createElement('div');
                if(m.sys) {
                    d.className = 'sys-msg';
                    d.innerText = m.text;
                } else {
                    d.className = `msg ${m.sender === currentUser.uid ? 'msg-me' : 'msg-partner'}`;
                    d.innerText = m.text;
                }
                const f = document.getElementById('chat-feed');
                f.appendChild(d);
                f.scrollTop = f.scrollHeight;
            });
        }

        function sendChat() {
            const t = document.getElementById('chat-in').value;
            if(!t) return;
            db.ref(`couples/${coupleId}/chat`).push({
                sender: currentUser.uid, text: t, timestamp: Date.now()
            });
            document.getElementById('chat-in').value = "";
        }

        // Init
        route();
    </script>
</body>
</html>
