<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ETERNAL WALL | The Digital Monument</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg: #050505;
            --surface: #121212;
            --surface-light: #1e1e1e;
            --border: #333;
            --text-main: #e0e0e0;
            --text-muted: #888;
            --primary: #d4af37; /* Luxury Gold */
            --primary-dim: #8a701f;
            --accent: #e91e63; /* Love Pink */
            --danger: #ff4757;
            --success: #2ed573;
            --glass: rgba(18, 18, 18, 0.85);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            padding-bottom: 80px; /* Space for mobile nav */
        }

        h1, h2, h3, .serif { font-family: 'Playfair Display', serif; }
        a { text-decoration: none; color: inherit; }
        button { cursor: pointer; transition: 0.2s; font-family: inherit; }

        /* --- UI COMPONENTS --- */
        .btn {
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: 600;
            border: none;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }
        .btn-primary { background: var(--primary); color: #000; }
        .btn-primary:hover { background: #f0c94e; transform: translateY(-2px); }
        .btn-outline { background: transparent; border: 1px solid var(--text-muted); color: var(--text-main); }
        .btn-danger { background: rgba(255, 71, 87, 0.1); color: var(--danger); border: 1px solid var(--danger); }
        .btn-success { background: var(--success); color: #000; }
        
        .input-box {
            background: var(--surface-light);
            border: 1px solid var(--border);
            color: white;
            padding: 15px;
            border-radius: 12px;
            width: 100%;
            margin-bottom: 15px;
            font-size: 1rem;
        }
        .input-box:focus { border-color: var(--primary); }

        /* --- NAVIGATION --- */
        .navbar {
            position: sticky; top: 0; z-index: 100;
            background: var(--glass);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .brand { font-size: 1.4rem; font-weight: 700; color: var(--primary); letter-spacing: 1px; }
        .nav-items { display: flex; gap: 15px; }

        /* --- VIEWS UTILS --- */
        .view { display: none; animation: fadeIn 0.4s ease; min-height: 80vh; }
        .active-view { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- VIEW: HOME --- */
        .hero {
            text-align: center; padding: 60px 20px;
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 70%);
        }
        .hero h1 { font-size: 3rem; margin-bottom: 10px; background: linear-gradient(to right, #fff, #999); -webkit-background-clip: text; -webkit-text-fill-color: transparent;}
        
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 2px;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 10px;
        }
        .tile {
            aspect-ratio: 1; position: relative; cursor: pointer; overflow: hidden; background: var(--surface);
        }
        .tile img { width: 100%; height: 100%; object-fit: cover; transition: 0.5s; opacity: 0.8; }
        .tile:hover img { transform: scale(1.1); opacity: 0.4; }
        .tile-overlay {
            position: absolute; inset: 0;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            opacity: 0; transition: 0.3s;
        }
        .tile:hover .tile-overlay { opacity: 1; }

        /* --- VIEW: PROFILE --- */
        .cover-photo {
            height: 300px; width: 100%; object-fit: cover;
            mask-image: linear-gradient(to bottom, black 50%, transparent 100%);
        }
        .profile-content { max-width: 900px; margin: -80px auto 0; padding: 20px; position: relative; }
        .names-large { font-size: 3.5rem; margin: 0; line-height: 1; text-shadow: 0 10px 30px rgba(0,0,0,0.8); }
        .profile-meta { display: flex; gap: 20px; margin: 20px 0; font-size: 0.9rem; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; }
        
        .memories-feed { display: flex; flex-direction: column; gap: 40px; margin-top: 40px; }
        .memory-card { background: var(--surface); border-radius: 1px; overflow: hidden; border: 1px solid var(--border); }
        .memory-img { width: 100%; display: block; }
        .memory-text { padding: 30px; font-family: 'Playfair Display'; font-size: 1.2rem; line-height: 1.6; text-align: center; color: #ccc; }

        /* --- VIEW: DASHBOARD --- */
        .dash-layout { display: flex; gap: 20px; max-width: 1200px; margin: 20px auto; padding: 0 20px; height: 85vh; }
        .dash-col-left { width: 350px; display: flex; flex-direction: column; gap: 20px; }
        .dash-col-right { flex: 1; background: var(--surface); border: 1px solid var(--border); border-radius: 16px; display: flex; flex-direction: column; overflow: hidden; }

        /* Proposals */
        .proposal-box { background: var(--surface); padding: 20px; border-radius: 16px; border: 1px solid var(--border); display: flex; flex-direction: column; height: 100%; }
        .prop-list { flex: 1; overflow-y: auto; margin-top: 15px; display: flex; flex-direction: column; gap: 10px; }
        
        .prop-item { background: var(--surface-light); padding: 12px; border-radius: 8px; border-left: 3px solid var(--text-muted); }
        .prop-item.pending { border-color: var(--primary); }
        .prop-actions { display: flex; gap: 5px; margin-top: 10px; }
        .badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: #333; }

        /* Chat */
        .chat-feed { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; background-image: radial-gradient(#222 1px, transparent 1px); background-size: 20px 20px; }
        .msg { max-width: 75%; padding: 10px 16px; border-radius: 18px; font-size: 0.95rem; line-height: 1.4; }
        .msg-me { background: var(--primary); color: #000; align-self: flex-end; border-bottom-right-radius: 4px; }
        .msg-partner { background: #2a2a2a; color: #fff; align-self: flex-start; border-bottom-left-radius: 4px; }
        .chat-input-bar { padding: 15px; background: var(--surface-light); border-top: 1px solid var(--border); display: flex; gap: 10px; }

        /* --- VIEW: AUTH --- */
        .auth-wrapper { display: flex; justify-content: center; align-items: center; min-height: 80vh; }
        .auth-card { background: var(--surface); padding: 40px; border-radius: 20px; border: 1px solid var(--border); width: 100%; max-width: 400px; text-align: center; }
        .blink-banner { background: linear-gradient(to right, var(--accent), #ff8e53); color: white; padding: 10px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; font-weight: bold; }

        /* Mobile */
        @media (max-width: 900px) {
            .dash-layout { flex-direction: column; height: auto; }
            .dash-col-left { width: 100%; height: 500px; }
            .dash-col-right { height: 500px; }
            .names-large { font-size: 2.5rem; }
        }
    </style>
</head>
<body>

    <!-- NAVBAR -->
    <nav class="navbar">
        <a href="#" onclick="route('home')" class="brand"><i class="fas fa-infinity"></i> ETERNAL</a>
        <div class="nav-items" id="nav-actions">
            <!-- Dynamic Buttons -->
        </div>
    </nav>

    <!-- 1. HOME VIEW -->
    <div id="view-home" class="view active-view">
        <div class="hero">
            <h1 class="serif">The Monument of Us</h1>
            <p style="color:var(--text-muted)">Secure your legacy in the digital universe.</p>
        </div>
        <div class="grid-container" id="public-grid">
            <!-- Tiles -->
        </div>
    </div>

    <!-- 2. PROFILE VIEW -->
    <div id="view-profile" class="view">
        <img src="" id="prof-cover" class="cover-photo">
        <div class="profile-content">
            <h1 id="prof-names" class="names-large serif">Loading...</h1>
            <div class="profile-meta">
                <span><i class="fas fa-hashtag"></i> <span id="prof-code">000</span></span>
                <span><i class="fas fa-heart"></i> EST. 2025</span>
            </div>
            <div class="memories-feed" id="prof-feed">
                <!-- Posts -->
            </div>
        </div>
    </div>

    <!-- 3. DASHBOARD VIEW -->
    <div id="view-dashboard" class="view">
        
        <!-- SINGLE MODE -->
        <div id="dash-single" class="auth-wrapper" style="display:none;">
            <div class="auth-card" style="text-align: left;">
                <h2 class="serif" style="color:var(--primary)">One Step Left</h2>
                <p style="color:var(--text-muted); margin-bottom: 20px;">Eternal Wall is for couples. Send this link to your partner to fuse your accounts.</p>
                <div style="background:#000; padding:15px; border-radius:8px; word-break:break-all; font-family:monospace; cursor:pointer;" onclick="copyBlink()" id="my-blink">Loading Link...</div>
                <div style="margin-top:10px; font-size:0.8rem; color:var(--success); text-align:center;">Click link to copy</div>
            </div>
        </div>

        <!-- COUPLE MODE -->
        <div id="dash-couple" class="dash-layout" style="display:none;">
            <!-- Left: Proposals -->
            <div class="dash-col-left">
                <div class="proposal-box">
                    <h3 class="serif"><i class="fas fa-pen-nib"></i> Draft Memory</h3>
                    <input type="text" id="prop-img" class="input-box" placeholder="Image URL (Required)">
                    <textarea id="prop-text" class="input-box" rows="2" placeholder="Write a caption..."></textarea>
                    <button class="btn btn-primary" style="width:100%" onclick="submitProposal()">Propose to Wall</button>
                    
                    <div style="border-top:1px solid var(--border); margin-top:20px; padding-top:10px;">
                        <small style="color:var(--text-muted)">PENDING APPROVALS</small>
                    </div>
                    <div class="prop-list" id="prop-list">
                        <!-- Proposals -->
                    </div>
                </div>
            </div>

            <!-- Right: Chat -->
            <div class="dash-col-right">
                <div style="padding:15px; border-bottom:1px solid var(--border); background:var(--surface-light); font-weight:bold;">
                    <i class="fas fa-comment-alt"></i> Private Channel
                </div>
                <div class="chat-feed" id="chat-feed"></div>
                <div class="chat-input-bar">
                    <input type="text" id="chat-input" class="input-box" style="margin:0; border-radius:50px;" placeholder="Message partner...">
                    <button onclick="sendChat()" style="background:var(--primary); width:50px; height:50px; border-radius:50%; border:none;"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. AUTH VIEW -->
    <div id="view-auth" class="view">
        <div class="auth-wrapper">
            <div class="auth-card">
                <div id="blink-alert" class="blink-banner" style="display:none;">
                    <i class="fas fa-link"></i> PARTNER INVITE DETECTED
                </div>
                <h2 id="auth-title" class="serif">Welcome</h2>
                <input type="text" id="username" class="input-box" placeholder="Your Name" style="display:none;">
                <input type="email" id="email" class="input-box" placeholder="Email">
                <input type="password" id="password" class="input-box" placeholder="Password">
                <button class="btn btn-primary" style="width:100%" onclick="handleAuth()" id="auth-submit">Log In</button>
                <div style="margin-top:20px; font-size:0.9rem; cursor:pointer; color:var(--text-muted);" onclick="toggleAuth()" id="auth-toggle">
                    Create Account
                </div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBUjzMFao9BS3uXBOW3qYrLVqHaGn8qIk4",
            authDomain: "onlineshop-30cd1.firebaseapp.com",
            databaseURL: "https://onlineshop-30cd1-default-rtdb.firebaseio.com",
            projectId: "onlineshop-30cd1",
            storageBucket: "onlineshop-30cd1.firebasestorage.app",
            messagingSenderId: "818252574868",
            appId: "1:818252574868:web:8dd36825db589a886cc481",
            measurementId: "G-6YLGGH2NDD"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let currentUser = null;
        let currentCoupleId = null;
        let isSignup = false;

        // --- ROUTER ---
        function route(page) {
            document.querySelectorAll('.view').forEach(e => e.classList.remove('active-view'));
            
            // Auto-handle Blink Link
            const params = new URLSearchParams(window.location.search);
            if(!page && params.get('blink')) page = 'auth';
            if(!page && params.get('page') === 'profile') {
                page = 'profile';
                loadProfile(params.get('id'));
            }
            if(!page) page = 'home';

            document.getElementById(`view-${page}`).classList.add('active-view');
            updateNav();

            if(page === 'auth' && params.get('blink')) setupBlinkAuth();
        }

        function updateNav() {
            const el = document.getElementById('nav-actions');
            if(currentUser) {
                el.innerHTML = `
                    <button class="btn btn-outline" onclick="route('dashboard')">DASHBOARD</button>
                    <button class="btn btn-primary" onclick="auth.signOut()">EXIT</button>
                `;
            } else {
                el.innerHTML = `<button class="btn btn-primary" onclick="route('auth')">LOGIN</button>`;
            }
        }

        // --- AUTH ---
        function toggleAuth() {
            isSignup = !isSignup;
            document.getElementById('auth-title').innerText = isSignup ? "Create Account" : "Log In";
            document.getElementById('auth-submit').innerText = isSignup ? "Join Eternal" : "Enter";
            document.getElementById('username').style.display = isSignup ? 'block' : 'none';
            document.getElementById('auth-toggle').innerText = isSignup ? "Have an account? Log In" : "New? Create Account";
        }

        function setupBlinkAuth() {
            isSignup = true;
            toggleAuth(); // Reset UI first
            isSignup = true; // Force true again
            document.getElementById('auth-title').innerText = "Connect Partner";
            document.getElementById('blink-alert').style.display = 'block';
            document.getElementById('auth-toggle').style.display = 'none'; // Hide switch
            document.getElementById('username').style.display = 'block';
        }

        async function handleAuth() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const name = document.getElementById('username').value;
            const params = new URLSearchParams(window.location.search);
            const invite = params.get('blink');

            try {
                if(isSignup) {
                    if(!name) return alert("Name required");
                    const cred = await auth.createUserWithEmailAndPassword(email, pass);
                    const uid = cred.user.uid;
                    let cId = null;

                    if(invite) {
                        const inviter = (await db.ref(`users/${invite}`).once('value')).val();
                        if(inviter && !inviter.coupleId) {
                            cId = `c_${Date.now()}`;
                            await db.ref(`couples/${cId}`).set({ u1: invite, u2: uid, created: Date.now() });
                            await db.ref(`users/${invite}`).update({ coupleId: cId });
                        }
                    }

                    await db.ref(`users/${uid}`).set({ name, email, coupleId: cId });
                    window.history.replaceState({}, document.title, window.location.pathname);
                } else {
                    await auth.signInWithEmailAndPassword(email, pass);
                }
                route('dashboard');
            } catch(e) { alert(e.message); }
        }

        // --- DASHBOARD ---
        auth.onAuthStateChanged(user => {
            currentUser = user;
            updateNav();
            if(user) {
                db.ref(`users/${user.uid}`).on('value', snap => {
                    const data = snap.val();
                    if(data.coupleId) {
                        currentCoupleId = data.coupleId;
                        initCoupleView();
                    } else {
                        initSingleView();
                    }
                });
            }
        });

        function initSingleView() {
            document.getElementById('dash-single').style.display = 'flex';
            document.getElementById('dash-couple').style.display = 'none';
            const link = `${window.location.origin}${window.location.pathname}?blink=${currentUser.uid}`;
            document.getElementById('my-blink').innerText = link;
        }

        function copyBlink() {
            navigator.clipboard.writeText(document.getElementById('my-blink').innerText);
            alert("Link Copied!");
        }

        function initCoupleView() {
            document.getElementById('dash-single').style.display = 'none';
            document.getElementById('dash-couple').style.display = 'flex';

            // CHAT LISTENER
            db.ref(`couples/${currentCoupleId}/chat`).limitToLast(50).on('child_added', s => {
                const msg = s.val();
                const div = document.createElement('div');
                div.className = `msg ${msg.uid === currentUser.uid ? 'msg-me' : 'msg-partner'}`;
                div.innerText = msg.text;
                const feed = document.getElementById('chat-feed');
                feed.appendChild(div);
                feed.scrollTop = feed.scrollHeight;
            });

            // PROPOSAL LISTENER (WITH DELETE/REJECT LOGIC)
            db.ref(`couples/${currentCoupleId}/proposals`).on('value', s => {
                const list = document.getElementById('prop-list');
                list.innerHTML = "";
                const data = s.val();
                if(!data) return;

                Object.keys(data).forEach(key => {
                    const p = data[key];
                    const div = document.createElement('div');
                    div.className = `prop-item ${p.status}`;
                    
                    // Logic for Buttons
                    let buttons = '';
                    if(p.status === 'pending') {
                        if(p.author === currentUser.uid) {
                            // I made this -> I can DELETE it
                            buttons = `<button class="btn-outline" style="font-size:0.7rem; padding:5px 10px;" onclick="removeProposal('${key}')"><i class="fas fa-trash"></i> Delete</button>`;
                        } else {
                            // Partner made this -> I can APPROVE or REJECT
                            buttons = `
                                <button class="btn-success" style="font-size:0.7rem; padding:5px 10px; border:none; border-radius:4px;" onclick="sealProposal('${key}')"><i class="fas fa-check"></i> SEAL IT</button>
                                <button class="btn-danger" style="font-size:0.7rem; padding:5px 10px; border-radius:4px;" onclick="removeProposal('${key}')"><i class="fas fa-times"></i> VETO</button>
                            `;
                        }
                    } else {
                        buttons = `<span class="badge" style="background:var(--primary); color:black">SEALED ON WALL</span>`;
                    }

                    div.innerHTML = `
                        <div style="font-size:0.9rem;">"${p.caption}"</div>
                        <div class="prop-actions">${buttons}</div>
                    `;
                    list.prepend(div);
                });
            });
        }

        function sendChat() {
            const inp = document.getElementById('chat-input');
            if(!inp.value) return;
            db.ref(`couples/${currentCoupleId}/chat`).push({
                uid: currentUser.uid, text: inp.value, time: Date.now()
            });
            inp.value = "";
        }

        function submitProposal() {
            const img = document.getElementById('prop-img').value;
            const txt = document.getElementById('prop-text').value;
            if(!img || !txt) return alert("Image and Caption required.");
            db.ref(`couples/${currentCoupleId}/proposals`).push({
                author: currentUser.uid,
                image: img, caption: txt, status: 'pending'
            });
            document.getElementById('prop-text').value = "";
        }

        function removeProposal(key) {
            if(confirm("Are you sure?")) {
                db.ref(`couples/${currentCoupleId}/proposals/${key}`).remove();
            }
        }

        async function sealProposal(key) {
            // Get data
            const snap = await db.ref(`couples/${currentCoupleId}/proposals/${key}`).once('value');
            const prop = snap.val();
            
            // Mark Sealed
            await db.ref(`couples/${currentCoupleId}/proposals/${key}`).update({ status: 'sealed' });

            // Get Names
            const cData = (await db.ref(`couples/${currentCoupleId}`).once('value')).val();
            const u1 = (await db.ref(`users/${cData.u1}`).once('value')).val().name;
            const u2 = (await db.ref(`users/${cData.u2}`).once('value')).val().name;

            // Push to Public Wall
            await db.ref('publicWall').push({
                cid: currentCoupleId,
                names: `${u1} & ${u2}`,
                image: prop.image,
                caption: prop.caption,
                time: Date.now()
            });
        }

        // --- PUBLIC WALL ---
        db.ref('publicWall').limitToLast(100).on('value', snap => {
            const grid = document.getElementById('public-grid');
            grid.innerHTML = "";
            const data = snap.val();
            if(!data) return;

            // Simple Set to show unique couples only on home page
            const seen = new Set();
            Object.values(data).reverse().forEach(post => {
                if(seen.has(post.cid)) return;
                seen.add(post.cid);

                const tile = document.createElement('div');
                tile.className = 'tile';
                tile.innerHTML = `
                    <img src="${post.image}">
                    <div class="tile-overlay">
                        <div class="serif" style="font-size:1.2rem; color:var(--primary);">${post.names}</div>
                        <button class="btn btn-outline" style="margin-top:10px; font-size:0.7rem;" onclick="window.location.href='?page=profile&id=${post.cid}'">VISIT</button>
                    </div>
                `;
                grid.appendChild(tile);
            });
        });

        async function loadProfile(id) {
            // Get Posts for this couple
            const snap = await db.ref('publicWall').orderByChild('cid').equalTo(id).once('value');
            const posts = snap.val();
            
            if(!posts) {
                document.getElementById('prof-names').innerText = "Not Found";
                return;
            }

            const arr = Object.values(posts).reverse();
            const latest = arr[0];

            document.getElementById('prof-cover').src = latest.image;
            document.getElementById('prof-names').innerText = latest.names;
            document.getElementById('prof-code').innerText = id.substring(5,10).toUpperCase();

            const feed = document.getElementById('prof-feed');
            feed.innerHTML = "";
            arr.forEach(p => {
                const card = document.createElement('div');
                card.className = 'memory-card';
                card.innerHTML = `
                    <img src="${p.image}" class="memory-img">
                    <div class="memory-text">"${p.caption}"</div>
                `;
                feed.appendChild(card);
            });
        }

        // Init
        route();

    </script>
</body>
</html>
