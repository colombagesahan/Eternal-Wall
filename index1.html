<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ETERNAL WALL | The Monument of Us</title>
    
    <!-- FONTS & ICONS -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <!-- EFFECTS -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --bg: #050505;
            --surface: rgba(20, 20, 20, 0.6);
            --surface-solid: #141414;
            --border: rgba(255, 255, 255, 0.1);
            --primary: #D4AF37; /* Luxury Gold */
            --primary-glow: rgba(212, 175, 55, 0.3);
            --accent: #E91E63; /* Love Pink */
            --text: #E0E0E0;
            --text-dim: #888;
            --glass: blur(12px);
            --success: #2ecc71;
            --danger: #ff4757;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            margin: 0;
            overflow-x: hidden;
            min-height: 100vh;
        }

        h1, h2, h3, .serif { font-family: 'Playfair Display', serif; }
        button { cursor: pointer; transition: 0.2s; font-family: inherit; }
        a { text-decoration: none; color: inherit; }

        /* --- ANIMATED MAP BACKGROUND --- */
        .map-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: radial-gradient(circle at center, #111 0%, #000 80%);
            overflow: hidden;
        }
        .map-dot {
            position: absolute; width: 6px; height: 6px; background: var(--primary);
            border-radius: 50%; opacity: 0; animation: pulseMap 4s infinite;
        }
        @keyframes pulseMap { 0% { opacity: 0; transform: scale(0.5); } 50% { opacity: 0.8; transform: scale(1.5); box-shadow: 0 0 15px var(--primary); } 100% { opacity: 0; transform: scale(0.5); } }

        /* --- UI COMPONENTS --- */
        .glass-panel {
            background: var(--surface); backdrop-filter: var(--glass);
            -webkit-backdrop-filter: var(--glass); border: 1px solid var(--border);
            border-radius: 16px; padding: 20px;
        }

        .btn {
            padding: 10px 20px; border-radius: 50px; font-weight: 600; border: none;
            display: inline-flex; align-items: center; gap: 8px; font-size: 0.9rem; justify-content: center;
        }
        .btn-gold { background: var(--primary); color: #000; box-shadow: 0 4px 15px var(--primary-glow); }
        .btn-gold:hover { transform: translateY(-2px); box-shadow: 0 6px 20px var(--primary-glow); }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-success { background: var(--success); color: #000; }
        .btn-danger { background: rgba(255, 71, 87, 0.1); color: var(--danger); border: 1px solid var(--danger); }

        .input-box {
            width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--border);
            color: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; font-family: inherit;
        }
        .input-box:focus { border-color: var(--primary); }

        /* --- NAVIGATION --- */
        .navbar {
            position: sticky; top: 0; z-index: 100;
            background: rgba(5, 5, 5, 0.85); backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border); padding: 15px 5%;
            display: flex; justify-content: space-between; align-items: center;
        }
        .brand { font-size: 1.4rem; color: var(--primary); letter-spacing: 1px; font-weight: bold; }
        
        .streak-badge {
            display: flex; align-items: center; gap: 5px; background: rgba(233, 30, 99, 0.1); 
            border: 1px solid var(--accent); color: var(--accent); padding: 5px 12px; 
            border-radius: 20px; font-size: 0.8rem; font-weight: bold;
        }

        /* --- VIEWS --- */
        .view { display: none; padding-top: 20px; padding-bottom: 80px; min-height: 90vh; animation: fadeIn 0.5s; }
        .active-view { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- VIEW: HOME (WALL) --- */
        .hero { text-align: center; padding: 40px 20px; margin-bottom: 20px; }
        .hero h1 { font-size: 3rem; margin-bottom: 10px; background: linear-gradient(to right, #fff, #888); -webkit-background-clip: text; -webkit-text-fill-color: transparent;}
        
        .search-container { max-width: 400px; margin: 0 auto 40px; }

        .wall-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 2px; max-width: 1400px; margin: 0 auto; padding: 0 10px;
        }
        .tile {
            aspect-ratio: 1; position: relative; cursor: pointer; overflow: hidden; background: #111;
        }
        .tile img { width: 100%; height: 100%; object-fit: cover; transition: 0.5s; opacity: 0.8; }
        .tile:hover img { transform: scale(1.1); opacity: 0.4; }
        .tile-overlay {
            position: absolute; inset: 0; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; opacity: 0; transition: 0.3s;
            background: rgba(0,0,0,0.4); text-align: center; padding: 5px;
        }
        .tile:hover .tile-overlay { opacity: 1; }

        /* --- VIEW: PROFILE --- */
        .prof-header { text-align: center; padding: 40px 20px; }
        .prof-cover { 
            width: 140px; height: 140px; border-radius: 50%; object-fit: cover; 
            border: 3px solid var(--primary); margin-bottom: 20px; box-shadow: 0 0 30px var(--primary-glow);
        }
        .prof-grid { 
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; 
            max-width: 800px; margin: 0 auto; padding: 10px; 
        }
        .prof-item { aspect-ratio: 1; cursor: pointer; position: relative; }
        .prof-item img { width: 100%; height: 100%; object-fit: cover; }

        /* --- VIEW: DASHBOARD --- */
        .dash-layout { 
            display: grid; grid-template-columns: 350px 1fr; gap: 20px; 
            max-width: 1200px; margin: 0 auto; padding: 0 20px; 
        }

        /* Clock Section */
        .clock-banner { 
            text-align: center; background: linear-gradient(90deg, #111, #1a1a1a); 
            padding: 20px; margin-bottom: 20px; border-bottom: 1px solid var(--border);
        }
        .clock-digits { font-family: monospace; font-size: 1.5rem; color: var(--primary); letter-spacing: 2px; }

        /* Mood Battery */
        .mood-track { height: 8px; background: #333; border-radius: 10px; margin: 15px 0; position: relative; cursor: pointer;}
        .mood-fill { height: 100%; background: linear-gradient(90deg, #ff4757, #2ecc71); width: 50%; border-radius: 10px; transition: width 0.3s; }
        .mood-thumb { position: absolute; top: 50%; transform: translate(-50%, -50%); width: 16px; height: 16px; background: white; border-radius: 50%; box-shadow: 0 0 10px white; }

        /* Daily Pulse */
        .pulse-card { border-left: 3px solid var(--accent); }
        .blur-ans { filter: blur(8px); cursor: pointer; transition: 0.3s; }
        .blur-ans:hover { filter: blur(4px); }
        .reveal { filter: none !important; }

        /* Proposals */
        .prop-item { 
            background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; 
            margin-bottom: 10px; border-left: 2px solid var(--text-dim); 
        }
        .prop-pending { border-color: var(--primary); }

        /* Chat Floating */
        .chat-fab {
            position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px;
            background: var(--primary); border-radius: 50%; display: flex; 
            justify-content: center; align-items: center; color: black; font-size: 1.5rem;
            cursor: pointer; box-shadow: 0 5px 20px var(--primary-glow); z-index: 90;
        }
        .chat-modal {
            position: fixed; bottom: 90px; right: 20px; width: 350px; height: 500px;
            background: #111; border: 1px solid var(--border); border-radius: 16px;
            display: none; flex-direction: column; z-index: 90; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .chat-feed { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        .msg { padding: 8px 12px; border-radius: 12px; max-width: 80%; font-size: 0.9rem; }
        .msg-me { background: var(--primary); color: black; align-self: flex-end; }
        .msg-partner { background: #333; align-self: flex-start; }
        .sys-msg { align-self: center; font-size: 0.75rem; color: #888; margin: 5px 0; font-style: italic; }

        /* --- AUTH --- */
        .auth-container { max-width: 400px; margin: 5vh auto; text-align: center; }
        .blink-alert { 
            background: linear-gradient(45deg, var(--accent), #ff9f43); color: white; 
            padding: 15px; border-radius: 8px; margin-bottom: 20px; font-weight: bold;
        }

        /* Mobile */
        @media (max-width: 900px) {
            .dash-layout { grid-template-columns: 1fr; }
            .chat-modal { width: 90%; right: 5%; bottom: 90px; }
        }
    </style>
</head>
<body>

    <div class="map-bg" id="map-canvas">
        <!-- JS injects dots here -->
    </div>

    <!-- NAVIGATION -->
    <nav class="navbar">
        <a href="#" onclick="route('home')" class="brand">ETERNAL WALL</a>
        <div style="display:flex; gap:10px; align-items:center;">
            <div id="streak-badge" class="streak-badge" style="display:none;">
                <i class="fas fa-fire"></i> <span id="streak-num">0</span>
            </div>
            <div id="nav-actions">
                <!-- Injected by JS -->
            </div>
        </div>
    </nav>

    <!-- 1. HOME VIEW (PUBLIC WALL) -->
    <div id="view-home" class="view active-view">
        <div class="hero">
            <h1 class="serif">The Monument of Us</h1>
            <div class="search-container">
                <input type="text" id="search-input" class="input-box" placeholder="üîç Find Couple by #CODE..." onkeyup="filterWall()">
            </div>
        </div>
        <div class="wall-grid" id="wall-grid">
            <!-- Public Tiles -->
        </div>
    </div>

    <!-- 2. PROFILE VIEW -->
    <div id="view-profile" class="view">
        <div class="prof-header">
            <img src="" id="p-img" class="prof-cover">
            <h1 class="serif" id="p-names" style="margin:0;">Loading...</h1>
            <div style="color:var(--primary); letter-spacing:2px; margin-top:5px;" id="p-code">#CODE</div>
            <p style="color:var(--text-dim); margin-top:10px;" id="p-bio">United on Eternal Wall.</p>
        </div>
        <div class="prof-grid" id="p-grid">
            <!-- Sealed Memories -->
        </div>
    </div>

    <!-- 3. DASHBOARD VIEW (COUPLE OS) -->
    <div id="view-dashboard" class="view">
        
        <!-- SINGLE STATE -->
        <div id="dash-single" class="glass-panel" style="max-width:500px; margin: 40px auto; text-align:center; display:none;">
            <h2 class="serif" style="color:var(--primary)">Missing Piece</h2>
            <p style="color:var(--text-dim)">Eternal Wall is designed for two. Invite your partner to unlock the Dashboard.</p>
            <div style="background:rgba(0,0,0,0.5); padding:10px; margin:15px 0; font-family:monospace; word-break:break-all; cursor:pointer;" onclick="copyBlink()" id="my-blink">Loading...</div>
            <button class="btn btn-gold" onclick="copyBlink()">COPY INVITE LINK</button>
        </div>

        <!-- COUPLE STATE -->
        <div id="dash-couple" style="display:none;">
            
            <div class="clock-banner">
                <div style="font-size:0.8rem; color:var(--text-dim); margin-bottom:5px;">TOGETHER FOR</div>
                <div class="clock-digits" id="timer-display">00 : 00 : 00 : 00</div>
                <div style="font-size:0.7rem; color:var(--primary); margin-top:5px;">Y : D : H : M</div>
            </div>

            <div class="dash-layout">
                <!-- LEFT COL: INTERACTION -->
                <div style="display:flex; flex-direction:column; gap:20px;">
                    
                    <!-- Mood Battery -->
                    <div class="glass-panel">
                        <div style="display:flex; justify-content:space-between; font-size:0.9rem;">
                            <span><i class="fas fa-battery-half"></i> Social Battery</span>
                            <span id="mood-val" style="color:var(--text-dim)">Neutral</span>
                        </div>
                        <div class="mood-track" id="mood-track" onclick="setMood(event)">
                            <div class="mood-fill" id="mood-bar"></div>
                            <div class="mood-thumb" id="mood-thumb"></div>
                        </div>
                    </div>

                    <!-- Daily Pulse -->
                    <div class="glass-panel pulse-card">
                        <div style="font-size:0.7rem; color:var(--accent); font-weight:bold; margin-bottom:10px;">DAILY PULSE</div>
                        <h3 class="serif" id="pulse-q" style="margin-top:0;">...</h3>
                        
                        <div id="pulse-input-div">
                            <input id="pulse-in" class="input-box" placeholder="Your Answer...">
                            <button class="btn btn-outline" style="width:100%" onclick="submitPulse()">Answer</button>
                        </div>
                        
                        <div id="pulse-result" style="display:none; margin-top:15px;">
                            <div style="margin-bottom:5px;"><small>YOU:</small> <span id="ans-me" style="color:var(--primary)"></span></div>
                            <div><small>PARTNER:</small> <span id="ans-partner" class="blur-ans" onclick="this.classList.add('reveal')">...</span></div>
                        </div>
                    </div>

                    <!-- Time Capsule -->
                    <div class="glass-panel">
                        <h3 class="serif"><i class="fas fa-box-archive"></i> Time Capsule</h3>
                        <div style="display:flex; gap:5px; margin-bottom:10px;">
                            <input id="cap-msg" class="input-box" placeholder="Message..." style="margin:0;">
                            <input type="date" id="cap-date" class="input-box" style="width:140px; margin:0;">
                        </div>
                        <button class="btn btn-outline" style="width:100%" onclick="addCapsule()">Lock Away</button>
                        <div id="cap-list" style="margin-top:15px; font-size:0.9rem;"></div>
                    </div>

                </div>

                <!-- RIGHT COL: PROPOSALS -->
                <div class="glass-panel">
                    <h3 class="serif"><i class="fas fa-pen-nib"></i> Wall Proposals</h3>
                    <p style="font-size:0.8rem; color:var(--text-dim);">Both partners must agree to publish to the Eternal Wall.</p>
                    
                    <div style="background:rgba(0,0,0,0.3); padding:15px; border-radius:8px; margin-bottom:20px;">
                        <input id="prop-img" class="input-box" placeholder="Image URL (Required for Tile)">
                        <textarea id="prop-txt" class="input-box" rows="2" placeholder="Caption..."></textarea>
                        <button class="btn btn-gold" style="width:100%" onclick="submitProposal()">Create Draft</button>
                    </div>

                    <div id="prop-list">
                        <!-- Items injected here -->
                    </div>
                </div>
            </div>

            <!-- FLOATING CHAT -->
            <div class="chat-fab" onclick="toggleChat()"><i class="fas fa-comment"></i></div>
            
            <div class="chat-modal" id="chat-win">
                <div style="padding:15px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
                    <span class="serif">Private Chat</span>
                    <i class="fas fa-times" style="cursor:pointer;" onclick="toggleChat()"></i>
                </div>
                
                <div class="chat-feed" id="chat-feed"></div>
                
                <!-- Toolkit -->
                <div style="padding:10px; display:flex; gap:5px; overflow-x:auto;">
                    <button class="btn-outline" style="font-size:0.7rem; padding:5px 10px;" onclick="runTool('coin')">ü™ô Flip</button>
                    <button class="btn-outline" style="font-size:0.7rem; padding:5px 10px;" onclick="runTool('wheel')">üçï Dinner</button>
                    <button class="btn-outline" style="font-size:0.7rem; padding:5px 10px;" onclick="runTool('sorry')">‚ù§Ô∏è Sorry</button>
                </div>

                <div style="padding:10px; display:flex; gap:5px; border-top:1px solid var(--border);">
                    <input id="chat-in" class="input-box" style="margin:0; border-radius:20px;" placeholder="Message...">
                    <button onclick="sendChat()" style="background:var(--primary); width:40px; height:40px; border-radius:50%; border:none;"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>

        </div>
    </div>

    <!-- 4. AUTH VIEW -->
    <div id="view-auth" class="view">
        <div class="auth-container glass-panel">
            <h1 class="serif" style="margin-bottom:10px;">Sanctuary</h1>
            
            <div id="blink-alert" class="blink-alert" style="display:none;">
                <i class="fas fa-link"></i> CONNECTING TO PARTNER...
            </div>

            <input id="u-name" class="input-box" placeholder="Your Name" style="display:none;">
            <input id="u-email" class="input-box" placeholder="Email Address">
            <input id="u-pass" type="password" class="input-box" placeholder="Password">
            
            <button class="btn btn-gold" style="width:100%; margin-top:10px;" onclick="handleAuth()" id="btn-auth">ENTER</button>
            <p style="margin-top:20px; font-size:0.9rem; cursor:pointer; color:var(--text-dim);" onclick="toggleAuth()" id="txt-switch">New? Create Account</p>
        </div>
    </div>

    <!-- JAVASCRIPT ENGINE -->
    <script>
        // --- 1. FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBUjzMFao9BS3uXBOW3qYrLVqHaGn8qIk4",
            authDomain: "onlineshop-30cd1.firebaseapp.com",
            databaseURL: "https://onlineshop-30cd1-default-rtdb.firebaseio.com",
            projectId: "onlineshop-30cd1",
            storageBucket: "onlineshop-30cd1.firebasestorage.app",
            messagingSenderId: "818252574868",
            appId: "1:818252574868:web:8dd36825db589a886cc481",
            measurementId: "G-6YLGGH2NDD"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // --- 2. GLOBAL STATE ---
        let user = null;
        let coupleId = null;
        let isSignup = false;

        // --- 3. ROUTER ---
        function route(page) {
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active-view'));
            
            const params = new URLSearchParams(window.location.search);
            if(!page && params.get('blink')) page = 'auth';
            if(!page && params.get('page') === 'profile') {
                page = 'profile';
                loadProfile(params.get('id'));
            }
            if(!page) page = 'home';

            document.getElementById(`view-${page}`).classList.add('active-view');
            updateNav();

            if(page === 'home') initMapFX();
            if(page === 'auth' && params.get('blink')) setupBlinkUI();
        }

        function updateNav() {
            const container = document.getElementById('nav-actions');
            if(user) {
                container.innerHTML = `
                    <button class="btn btn-outline" onclick="route('dashboard')">Dashboard</button>
                    <button class="btn btn-danger" style="padding:5px 10px;" onclick="auth.signOut()"><i class="fas fa-power-off"></i></button>
                `;
            } else {
                container.innerHTML = `<button class="btn btn-gold" onclick="route('auth')">Login</button>`;
            }
        }

        // --- 4. AUTH & BLINK ---
        function toggleAuth() {
            isSignup = !isSignup;
            document.getElementById('u-name').style.display = isSignup ? 'block' : 'none';
            document.getElementById('btn-auth').innerText = isSignup ? "JOIN" : "ENTER";
            document.getElementById('txt-switch').innerText = isSignup ? "Have an account? Log In" : "New? Create Account";
        }

        function setupBlinkUI() {
            isSignup = true;
            toggleAuth(); isSignup = true; // Force UI reset then set true
            document.getElementById('blink-alert').style.display = 'block';
            document.getElementById('txt-switch').style.display = 'none';
        }

        async function handleAuth() {
            const email = document.getElementById('u-email').value;
            const pass = document.getElementById('u-pass').value;
            const name = document.getElementById('u-name').value;
            const blink = new URLSearchParams(window.location.search).get('blink');

            try {
                if(isSignup) {
                    const cred = await auth.createUserWithEmailAndPassword(email, pass);
                    const uid = cred.user.uid;
                    let cid = null;

                    // IF INVITE EXISTS
                    if(blink) {
                        const inviter = (await db.ref(`users/${blink}`).once('value')).val();
                        if(inviter && !inviter.coupleId) {
                            cid = `c_${Date.now()}`;
                            // Create Couple
                            await db.ref(`couples/${cid}`).set({
                                u1: blink, u2: uid,
                                start: Date.now(),
                                created: Date.now()
                            });
                            // Update Inviter
                            await db.ref(`users/${blink}`).update({ coupleId: cid });
                        }
                    }

                    await db.ref(`users/${uid}`).set({ name, email, coupleId: cid });
                    // Clean URL
                    window.history.replaceState({}, '', location.pathname);

                } else {
                    await auth.signInWithEmailAndPassword(email, pass);
                }
                route('dashboard');
            } catch(e) { alert(e.message); }
        }

        // --- 5. DASHBOARD CORE ---
        auth.onAuthStateChanged(u => {
            user = u;
            updateNav();
            if(u) {
                db.ref(`users/${u.uid}`).on('value', s => {
                    const d = s.val();
                    if(d.coupleId) {
                        coupleId = d.coupleId;
                        initCoupleOS();
                    } else {
                        initSingle();
                    }
                });
            }
        });

        function initSingle() {
            document.getElementById('dash-single').style.display = 'block';
            document.getElementById('dash-couple').style.display = 'none';
            document.getElementById('streak-badge').style.display = 'none';
            document.getElementById('my-blink').innerText = `${location.origin}${location.pathname}?blink=${user.uid}`;
        }
        function copyBlink() {
            navigator.clipboard.writeText(document.getElementById('my-blink').innerText);
            alert("Invite copied!");
        }

        function initCoupleOS() {
            document.getElementById('dash-single').style.display = 'none';
            document.getElementById('dash-couple').style.display = 'block';
            
            initClock();
            initStreak();
            initMood();
            initPulse();
            initCapsule();
            initProposals();
            initChat();
        }

        // --- FEATURES ---

        // CLOCK
        function initClock() {
            db.ref(`couples/${coupleId}/start`).on('value', s => {
                const start = s.val() || Date.now();
                setInterval(() => {
                    const diff = Date.now() - start;
                    const d = Math.floor(diff / 86400000);
                    const h = Math.floor((diff / 3600000) % 24);
                    const m = Math.floor((diff / 60000) % 60);
                    document.getElementById('timer-display').innerText = `${d} : ${h} : ${m}`;
                }, 1000);
            });
        }

        // STREAK
        function initStreak() {
            document.getElementById('streak-badge').style.display = 'flex';
            // Update Activity
            db.ref(`couples/${coupleId}/streak/last`).set(Date.now());
            // Listen
            db.ref(`couples/${coupleId}/streak`).on('value', s => {
                // Simulating streak for demo
                document.getElementById('streak-num').innerText = "üî•"; 
            });
        }

        // MOOD
        function initMood() {
            db.ref(`couples/${coupleId}/mood`).on('value', s => {
                const data = s.val();
                if(!data) return;
                // Find Partner's mood
                const pId = Object.keys(data).find(k => k !== user.uid);
                if(pId) {
                    const val = data[pId];
                    document.getElementById('mood-bar').style.width = val + '%';
                    document.getElementById('mood-thumb').style.left = val + '%';
                    document.getElementById('mood-val').innerText = `Partner: ${val}%`;
                }
            });
        }
        function setMood(e) {
            const rect = document.getElementById('mood-track').getBoundingClientRect();
            const pct = Math.min(100, Math.max(0, ((e.clientX - rect.left) / rect.width) * 100));
            db.ref(`couples/${coupleId}/mood/${user.uid}`).set(Math.floor(pct));
        }

        // DAILY PULSE
        function initPulse() {
            const qs = ["Best memory?", "Dream trip?", "Fav food?", "Pet peeve?"];
            const idx = Math.floor(Date.now() / 86400000) % qs.length;
            document.getElementById('pulse-q').innerText = qs[idx];
            
            const today = new Date().toISOString().split('T')[0];
            db.ref(`couples/${coupleId}/pulse/${today}`).on('value', s => {
                const d = s.val();
                if(d && d[user.uid]) {
                    document.getElementById('pulse-input-div').style.display = 'none';
                    document.getElementById('pulse-result').style.display = 'block';
                    document.getElementById('ans-me').innerText = d[user.uid];
                    
                    const pId = Object.keys(d).find(k => k !== user.uid);
                    const pAns = document.getElementById('ans-partner');
                    if(pId) {
                        pAns.innerText = d[pId];
                        // If partner has answered, show effect
                        if(!pAns.classList.contains('reveal')) confetti();
                    } else {
                        pAns.innerText = "Waiting...";
                        pAns.classList.remove('blur-ans');
                    }
                }
            });
        }
        function submitPulse() {
            const v = document.getElementById('pulse-in').value;
            if(!v) return;
            const today = new Date().toISOString().split('T')[0];
            db.ref(`couples/${coupleId}/pulse/${today}/${user.uid}`).set(v);
        }

        // TIME CAPSULE
        function initCapsule() {
            db.ref(`couples/${coupleId}/capsules`).on('value', s => {
                const l = document.getElementById('cap-list');
                l.innerHTML = "";
                const d = s.val();
                if(!d) return;
                Object.values(d).forEach(c => {
                    const locked = Date.now() < c.unlock;
                    l.innerHTML += `<div style="padding:5px; background:rgba(255,255,255,0.05); margin-bottom:5px; border-radius:4px; display:flex; align-items:center; gap:10px;">
                        <i class="fas ${locked ? 'fa-lock' : 'fa-envelope-open'}"></i>
                        ${locked ? `Opens ${new Date(c.unlock).toLocaleDateString()}` : c.msg}
                    </div>`;
                });
            });
        }
        function addCapsule() {
            const m = document.getElementById('cap-msg').value;
            const d = document.getElementById('cap-date').value;
            if(!m || !d) return;
            db.ref(`couples/${coupleId}/capsules`).push({ msg:m, unlock: new Date(d).getTime() });
            document.getElementById('cap-msg').value = "";
        }

        // PROPOSALS (AGREE POSTING)
        function initProposals() {
            db.ref(`couples/${coupleId}/proposals`).on('value', s => {
                const list = document.getElementById('prop-list');
                list.innerHTML = "";
                const data = s.val();
                if(!data) return;

                Object.keys(data).forEach(key => {
                    const p = data[key];
                    const div = document.createElement('div');
                    div.className = `prop-item ${p.status === 'pending' ? 'prop-pending' : ''}`;
                    
                    let btns = "";
                    if(p.status === 'pending') {
                        if(p.author === user.uid) {
                            // I wrote it -> I can delete
                            btns = `<button class="btn-danger" style="font-size:0.7rem; padding:4px 8px;" onclick="delProp('${key}')">Delete Draft</button>`;
                        } else {
                            // Partner wrote it -> I can Agree or Veto
                            btns = `
                                <div style="display:flex; gap:5px; margin-top:5px;">
                                    <button class="btn-success" style="font-size:0.7rem; padding:4px 8px;" onclick="sealProp('${key}')">SEAL IT</button>
                                    <button class="btn-danger" style="font-size:0.7rem; padding:4px 8px;" onclick="delProp('${key}')">VETO</button>
                                </div>
                            `;
                        }
                    } else {
                        btns = `<small style="color:var(--primary)">SEALED ON WALL</small>`;
                    }

                    div.innerHTML = `
                        <div style="font-size:0.9rem;">"${p.caption}"</div>
                        ${btns}
                    `;
                    list.prepend(div);
                });
            });
        }
        function submitProposal() {
            const img = document.getElementById('prop-img').value;
            const txt = document.getElementById('prop-txt').value;
            if(!img || !txt) return alert("Image URL and Caption required");
            db.ref(`couples/${coupleId}/proposals`).push({
                author: user.uid, image: img, caption: txt, status: 'pending'
            });
            document.getElementById('prop-txt').value = "";
        }
        function delProp(key) {
            if(confirm("Remove this proposal?")) db.ref(`couples/${coupleId}/proposals/${key}`).remove();
        }
        async function sealProp(key) {
            // Update Status
            await db.ref(`couples/${coupleId}/proposals/${key}`).update({ status: 'sealed' });
            
            // Get Data
            const prop = (await db.ref(`couples/${coupleId}/proposals/${key}`).once('value')).val();
            const cData = (await db.ref(`couples/${coupleId}`).once('value')).val();
            const u1 = (await db.ref(`users/${cData.u1}`).once('value')).val().name;
            const u2 = (await db.ref(`users/${cData.u2}`).once('value')).val().name;

            // Post to Public Wall
            await db.ref('publicWall').push({
                cid: coupleId,
                names: `${u1} & ${u2}`,
                image: prop.image,
                caption: prop.caption,
                timestamp: Date.now()
            });
            confetti();
        }

        // CHAT & TOOLKIT
        function toggleChat() {
            const win = document.getElementById('chat-win');
            win.style.display = win.style.display === 'flex' ? 'none' : 'flex';
        }
        function initChat() {
            db.ref(`couples/${coupleId}/chat`).limitToLast(50).on('child_added', s => {
                const m = s.val();
                const d = document.createElement('div');
                if(m.sys) {
                    d.className = 'sys-msg';
                    d.innerText = m.text;
                } else {
                    d.className = `msg ${m.uid === user.uid ? 'msg-me' : 'msg-partner'}`;
                    d.innerText = m.text;
                }
                const f = document.getElementById('chat-feed');
                f.appendChild(d);
                f.scrollTop = f.scrollHeight;
            });
        }
        function sendChat() {
            const i = document.getElementById('chat-in');
            if(!i.value) return;
            db.ref(`couples/${coupleId}/chat`).push({ uid: user.uid, text: i.value });
            i.value = "";
        }
        function runTool(type) {
            let r = "";
            if(type==='coin') r = Math.random()>0.5 ? "Heads" : "Tails";
            if(type==='wheel') r = ["Pizza","Sushi","Tacos"][Math.floor(Math.random()*3)];
            if(type==='sorry') r = "Sent an Apology ‚ù§Ô∏è";
            db.ref(`couples/${coupleId}/chat`).push({ text:`[TOOL] ${type.toUpperCase()}: ${r}`, sys:true });
        }

        // --- 6. PUBLIC WALL & PROFILES ---
        function initMapFX() {
            const map = document.getElementById('map-canvas');
            map.innerHTML = "";
            for(let i=0; i<15; i++) {
                setTimeout(() => {
                    const d = document.createElement('div');
                    d.className = 'map-dot';
                    d.style.top = Math.random()*80+10+'%';
                    d.style.left = Math.random()*90+5+'%';
                    map.appendChild(d);
                }, i*800);
            }
        }

        db.ref('publicWall').limitToLast(100).on('value', s => {
            const g = document.getElementById('wall-grid');
            g.innerHTML = "";
            const d = s.val();
            if(!d) return;

            const seen = new Set();
            Object.values(d).reverse().forEach(p => {
                if(seen.has(p.cid)) return;
                seen.add(p.cid);

                const t = document.createElement('div');
                t.className = 'tile';
                t.onclick = () => window.location.href = `?page=profile&id=${p.cid}`;
                t.innerHTML = `
                    <img src="${p.image}">
                    <div class="tile-overlay">
                        <div class="serif" style="color:var(--primary); font-size:1.1rem;">${p.names}</div>
                        <div style="font-size:0.8rem; margin-top:5px;">CLICK TO VISIT</div>
                    </div>
                `;
                g.appendChild(t);
            });
        });

        function filterWall() {
            const q = document.getElementById('search-input').value.toUpperCase();
            // In a real app, query DB. Here we filter loaded DOM for demo simplicity
            // or just rely on visual scan for now.
            // Implementing basic ID search logic:
            if(q.length > 3) {
                 // Simulate finding
                 alert("Search feature connects to Backend Indexing in production.");
            }
        }

        async function loadProfile(cid) {
            const snap = await db.ref('publicWall').orderByChild('cid').equalTo(cid).once('value');
            const data = snap.val();
            
            if(!data) {
                document.getElementById('p-names').innerText = "Couple Not Found";
                return;
            }

            const posts = Object.values(data).reverse();
            const latest = posts[0];

            document.getElementById('p-names').innerText = latest.names;
            document.getElementById('p-code').innerText = `#${cid.substring(5,10).toUpperCase()}`;
            document.getElementById('p-img').src = latest.image;

            const g = document.getElementById('p-grid');
            g.innerHTML = "";
            posts.forEach(p => {
                const d = document.createElement('div');
                d.className = 'prof-item';
                d.innerHTML = `<img src="${p.image}">`;
                d.onclick = () => alert(p.caption); // Simple caption view
                g.appendChild(d);
            });
        }

        // START
        route();
    </script>
</body>
</html>
